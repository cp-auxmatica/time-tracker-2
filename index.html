<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hub Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⏱️</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Color Tokens */
            --background: #f8f9fa;
            --foreground: #111827;
            --card: #ffffff;
            --card-foreground: #111827;
            --primary: #030213;
            --primary-foreground: #ffffff;
            --muted: #e5e7eb;
            --muted-foreground: #6b7280;
            --border: #e5e7eb;
            --input-border: #d1d5db;
            --input-bg: #ffffff;
            --ring: #3b82f6;

            /* Priority Colors */
            --priority-high: #ef4444;
            --priority-medium: #f59e0b;
            --priority-low: #10b981;
        }

        .dark {
            --background: #09090b;
            --foreground: #fafafa;
            --card: #18181b;
            --card-foreground: #fafafa;
            --primary: #fafafa;
            --primary-foreground: #09090b;
            --muted: #27272a;
            --muted-foreground: #a1a1aa;
            --border: #27272a;
            --input-border: #3f3f46;
            --input-bg: #18181b;
        }


        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .badge { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; line-height: 1.2; border: 1px solid transparent; }
        .badge-priority-high { background-color: #fee2e2; border-color: #fecaca; color: #b91c1c; }
        .badge-priority-medium { background-color: #fffbeb; border-color: #fde68a; color: #b45309; }
        .badge-priority-low { background-color: #dcfce7; border-color: #bbf7d0; color: #15803d; }
        .dark .badge-priority-high { background-color: #3f1212; border-color: #5b2121; color: #f87171; }
        .dark .badge-priority-medium { background-color: #422006; border-color: #5a2e0e; color: #fb923c; }
        .dark .badge-priority-low { background-color: #062f1d; border-color: #0e4f2d; color: #4ade80; }
        
        .timer-display { font-variant-numeric: tabular-nums; }

        .expanded-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.4s ease-in-out; }
        .expanded-content > div { overflow: hidden; }
        .project-card.is-running .expanded-content { grid-template-rows: 1fr; }

        .page { display: none; }
        .page.active { display: block; }
        
        #top-nav button.active svg { color: var(--primary); }
        .sort-btn.active { background-color: var(--muted); }
        input[type="date"] { color-scheme: dark; }
        .dark input[type="date"] { color-scheme: dark; }
        input#dark-mode-toggle:checked ~ .dot { transform: translateX(100%); background-color: var(--primary); }

        .project-card.is-running {
            border-color: transparent;
            box-shadow: 0 0 0 2px var(--project-color, var(--border)), 0 4px 12px 0 rgba(0,0,0,0.1);
        }
        .dark .project-card.is-running {
            box-shadow: 0 0 0 2px var(--project-color, var(--border)), 0 0 20px 0 var(--project-color-glow, rgba(255,255,255,0.1));
        }
        
        .modal-backdrop {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 40;
        }
        .modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50;
        }

    </style>
</head>
<body class="bg-[var(--background)]">

    <div id="app-container">
        
        <header class="sticky top-0 bg-[var(--background)]/80 backdrop-blur-sm z-10">
            <div class="container mx-auto p-4 sm:p-6 max-w-2xl">
                 <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-black text-white w-8 h-8 flex items-center justify-center rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </div>
                        <div><h1 class="text-xl font-bold text-[var(--foreground)]">hub tracker</h1></div>
                    </div>
                    <button id="add-project-btn" class="bg-[var(--primary)] text-[var(--primary-foreground)] w-8 h-8 flex items-center justify-center rounded-full shadow-lg hover:bg-opacity-90 transition-transform transform hover:scale-105"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg></button>
                </div>
                 <nav id="top-nav" class="flex justify-around border-b border-[var(--border)]">
                    <button data-page="page-tracker" class="nav-btn flex-1 py-3 flex items-center justify-center text-gray-500 active">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    </button>
                    <button data-page="page-reports" class="nav-btn flex-1 py-3 flex items-center justify-center text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20V16"/></svg>
                    </button>
                    <button data-page="page-accomplishments" class="nav-btn flex-1 py-3 flex items-center justify-center text-gray-500">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                    </button>
                    <button data-page="page-settings" class="nav-btn flex-1 py-3 flex items-center justify-center text-gray-500">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                    </button>
                </nav>
            </div>
        </header>

        <main>
            <div id="page-tracker" class="page active">
                <div class="container mx-auto p-4 sm:p-6 max-w-2xl pt-0">
                    <div id="sort-controls" class="flex items-center justify-between space-x-2 mb-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-xs font-medium text-gray-500">Sort by:</span>
                            <button data-sort="priority" class="sort-btn text-xs font-semibold px-3 py-1 rounded-full active">Priority</button>
                            <button data-sort="name" class="sort-btn text-xs font-semibold px-3 py-1 rounded-full">Name</button>
                            <button data-sort="latest" class="sort-btn text-xs font-semibold px-3 py-1 rounded-full">Latest</button>
                        </div>
                        <div class="text-right">
                             <span class="text-xs font-medium text-gray-500">Today's Total</span>
                             <p id="dashboard-total-time" class="font-bold text-gray-800 dark:text-gray-200 timer-display"></p>
                        </div>
                    </div>
                    <section id="dashboard-section"><div id="dashboard-projects-list" class="space-y-4"></div></section>
                </div>
            </div>

            <div id="page-reports" class="page">
                <div class="container mx-auto p-4 sm:p-6 max-w-2xl pt-0">
                    <div id="reports-content"></div>
                </div>
            </div>
            
            <div id="page-accomplishments" class="page">
                <div class="container mx-auto p-4 sm:p-6 max-w-2xl pt-0">
                    <div class="bg-[var(--card)] p-4 rounded-lg border border-[var(--border)] space-y-3 mb-6">
                        <h2 class="font-semibold text-[var(--card-foreground)]">Log a new accomplishment</h2>
                        <select id="accomplishment-project-select" class="w-full p-2 border border-[var(--input-border)] rounded-md bg-[var(--input-bg)] text-[var(--foreground)]"></select>
                        <textarea id="accomplishment-text" placeholder="What did you accomplish today?" class="w-full p-2 border border-[var(--input-border)] rounded-md h-24 bg-[var(--input-bg)] text-[var(--foreground)]"></textarea>
                        <button id="save-accomplishment-btn" class="w-full bg-[var(--primary)] text-[var(--primary-foreground)] font-semibold py-2 rounded-md">Save</button>
                    </div>
                    <div id="accomplishments-list" class="space-y-3"></div>
                </div>
            </div>

            <div id="page-settings" class="page">
                <div class="container mx-auto p-4 sm:p-6 max-w-2xl pt-0 space-y-6">
                    <div class="bg-[var(--card)] p-4 rounded-lg border border-[var(--border)]">
                        <h2 class="text-lg font-semibold mb-3">Appearance</h2>
                        <div class="flex items-center justify-between">
                            <label for="dark-mode-toggle" class="font-medium">Dark Mode</label>
                            <label for="dark-mode-toggle" class="flex items-center cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" id="dark-mode-toggle" class="sr-only">
                                    <div class="block bg-gray-300 dark:bg-gray-600 w-12 h-6 rounded-full"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="bg-[var(--card)] p-4 rounded-lg border border-[var(--border)] space-y-3">
                        <h2 class="text-lg font-semibold">Data Management</h2>
                        <button id="import-json-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold border border-[var(--input-border)] hover:bg-[var(--muted)]">Import from JSON</button>
                        <button id="export-json-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold border border-[var(--input-border)] hover:bg-[var(--muted)]">Export to JSON</button>
                    </div>
                    <div class="bg-[var(--card)] p-4 rounded-lg border border-[var(--border)] space-y-3">
                        <h2 class="text-lg font-semibold">Export CSV Report</h2>
                        <div class="flex items-center gap-2 text-sm">
                            <input type="date" id="csv-date-start" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)] border-[var(--input-border)] text-[var(--foreground)]">
                            <span>to</span>
                            <input type="date" id="csv-date-end" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)] border-[var(--input-border)] text-[var(--foreground)]">
                        </div>
                        <button id="export-csv-btn" class="w-full bg-[var(--primary)] text-[var(--primary-foreground)] font-semibold py-2 rounded-md">Export CSV</button>
                    </div>
                </div>
                <input type="file" id="import-file-input" class="hidden" accept="application/json">
            </div>

            <div id="page-detail" class="page">
                <div id="detail-view-content" class="container mx-auto p-4 sm:p-6 max-w-2xl"></div>
            </div>
        </main>

        <div id="modal-backdrop" class="modal-backdrop hidden"></div>

        <div id="add-project-modal" class="modal hidden w-11/12 max-w-md">
             <div class="bg-[var(--card)] rounded-lg shadow-xl border border-[var(--border)] p-6 space-y-4">
                <h2 class="text-xl font-bold">Add New Project</h2>
                <div>
                    <label for="new-project-name" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Project Name</label>
                    <input type="text" id="new-project-name" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)] text-[var(--foreground)] border-[var(--input-border)]" placeholder="e.g., Q4 Marketing Campaign">
                </div>
                 <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label for="new-project-priority" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Priority</label>
                        <select id="new-project-priority" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)] text-[var(--foreground)] border-[var(--input-border)]">
                            <option value="">None</option>
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div >
                         <label for="new-project-color" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Color</label>
                         <input type="color" id="new-project-color" value="#f87171" class="w-full h-10 p-1 border rounded-md bg-[var(--input-bg)] border-[var(--input-border)]">
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button id="cancel-add-project-btn" class="px-4 py-2 text-sm font-semibold rounded-lg hover:bg-[var(--muted)]">Cancel</button>
                    <button id="save-project-btn" class="px-4 py-2 text-sm font-semibold text-[var(--primary-foreground)] bg-[var(--primary)] rounded-lg">Save Project</button>
                </div>
            </div>
        </div>

    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Global State ---
        let projects = [], tasks = [], accomplishments = [], activeTimer = null, timerInterval = null;
        let currentDetailProjectId = null;
        let currentSort = 'priority';

        // --- Mock Data ---
        const setupMockData = async () => {
            await Promise.all([clearData('projects'), clearData('tasks'), clearData('accomplishments')]);
            const mockProjects = [
                { id: 1, name: 'Design System', priority: 'high', color: '#f87171' },
                { id: 2, name: 'Client Work', priority: 'high', color: '#4ade80' },
                { id: 3, name: 'Learning', priority: 'medium', color: '#facc15' },
                { id: 4, name: 'Research', priority: 'medium', color: '#a78bfa' },
                { id: 5, name: 'Marketing', priority: 'low', color: '#60a5fa' },
            ];
            const now = Date.now();
            const mockTasks = [
                { projectId: 1, description: "Initial components", notes: "Setup Storybook.", startTime: now - (105 * 60 * 1000), endTime: now },
                { projectId: 1, description: "Color palette", notes: "", startTime: now - (2 * 24 * 3600 * 1000), endTime: now - (2 * 24 * 3600 * 1000) + 3600000 },
                { projectId: 2, description: "Homepage mockups", notes: "For v1.", startTime: now - (200 * 60 * 1000), endTime: now - (50 * 60 * 1000) },
                { projectId: 3, description: "Vue course", notes: "", startTime: now - (3 * 24 * 3600 * 1000), endTime: now - (3 * 24 * 3600 * 1000) + (120 * 60000) },
            ];
            await Promise.all(mockProjects.map(p => addData('projects', p)));
            await Promise.all(mockTasks.map(t => addData('tasks', t)));
        };

        // --- DOM Element Cache ---
        const elements = {
            dashboardProjectsList: document.getElementById('dashboard-projects-list'),
            addProjectBtn: document.getElementById('add-project-btn'),
            detailViewContent: document.getElementById('detail-view-content'),
            navButtons: document.querySelectorAll('.nav-btn'),
            pages: document.querySelectorAll('.page'),
            reportsContent: document.getElementById('reports-content'),
            accomplishmentProjectSelect: document.getElementById('accomplishment-project-select'),
            accomplishmentText: document.getElementById('accomplishment-text'),
            saveAccomplishmentBtn: document.getElementById('save-accomplishment-btn'),
            accomplishmentsList: document.getElementById('accomplishments-list'),
            sortControls: document.getElementById('sort-controls'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            importJsonBtn: document.getElementById('import-json-btn'),
            exportJsonBtn: document.getElementById('export-json-btn'),
            exportCsvBtn: document.getElementById('export-csv-btn'),
            importFileInput: document.getElementById('import-file-input'),
            csvDateStart: document.getElementById('csv-date-start'),
            csvDateEnd: document.getElementById('csv-date-end'),
            modalBackdrop: document.getElementById('modal-backdrop'),
            addProjectModal: document.getElementById('add-project-modal'),
            saveProjectBtn: document.getElementById('save-project-btn'),
            cancelAddProjectBtn: document.getElementById('cancel-add-project-btn'),
            newProjectName: document.getElementById('new-project-name'),
            newProjectPriority: document.getElementById('new-project-priority'),
            newProjectColor: document.getElementById('new-project-color'),
        };

        // --- Helper Functions ---
        const formatTime = (ms) => new Date(ms).toISOString().slice(11, 19);
        const formatDuration = (ms) => {
             if (ms < 60000) return "0m";
             const hours = Math.floor(ms / 3600000);
             const minutes = Math.floor((ms % 3600000) / 60000);
             return `${hours > 0 ? `${hours}h ` : ''}${minutes}m`;
        };
        const getTodaysTimeForProject = (projectId) => {
            const startOfDay = new Date().setHours(0, 0, 0, 0);
            let totalMs = tasks.filter(t => t.projectId === projectId && t.endTime >= startOfDay).reduce((sum, task) => sum + (task.endTime - task.startTime), 0);
            if (activeTimer && activeTimer.projectId === projectId) totalMs += (Date.now() - activeTimer.startTime);
            return formatDuration(totalMs);
        };
        const downloadFile = (data, filename, type) => {
            const blob = new Blob([data], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };
        const getBorderColorFromPriority = (priority) => {
            const borderColors = { 'low': 'var(--priority-low)', 'medium': 'var(--priority-medium)', 'high': 'var(--priority-high)' };
            return borderColors[priority] || 'var(--muted)';
        };

        // --- IndexedDB ---
        let db; const DB_VERSION = 15; 
        const openDB = () => new Promise(r=>{const req=indexedDB.open('timeTrackerDB',DB_VERSION);req.onupgradeneeded=e=>{db=e.target.result;if(!db.objectStoreNames.contains('projects'))db.createObjectStore('projects',{keyPath:'id'});if(!db.objectStoreNames.contains('tasks'))db.createObjectStore('tasks',{keyPath:'id',autoIncrement:true}).createIndex('projectId','projectId');if(!db.objectStoreNames.contains('accomplishments'))db.createObjectStore('accomplishments',{keyPath:'id',autoIncrement:true}).createIndex('date','date');};req.onsuccess=e=>{db=e.target.result;r(db)};});
        const addData = (store, data) => new Promise((resolve, reject) => { const req = db.transaction(store, 'readwrite').objectStore(store).add(data); req.onsuccess = e => resolve(e.target.result); req.onerror = e => reject(e.target.error); });
        const updateData = (store, data) => new Promise((resolve, reject) => { const req = db.transaction(store, 'readwrite').objectStore(store).put(data); req.onsuccess = () => resolve(); req.onerror = e => reject(e.target.error); });
        const deleteData = (store, id) => new Promise(r => db.transaction(store, 'readwrite').objectStore(store).delete(id).onsuccess = () => r());
        const getAllData = (store) => new Promise(r => db.transaction(store, 'readonly').objectStore(store).getAll().onsuccess = e => r(e.target.result));
        const clearData = (store) => new Promise(r => db.transaction(store, 'readwrite').objectStore(store).clear().onsuccess = () => r());

        // --- Data & State Management ---
        const loadData = async () => { await openDB(); [projects, tasks, accomplishments] = await Promise.all([getAllData('projects'), getAllData('tasks'), getAllData('accomplishments')]); if (projects.length === 0) { await setupMockData(); [projects, tasks] = await Promise.all([getAllData('projects'), getAllData('tasks')]); } renderDashboardProjects(); updateDashboardTotalTime(); };
        const checkPersistentTimer = () => { const s = localStorage.getItem('activeTimerState'); if (s) { activeTimer = JSON.parse(s); startTimerInterval(); } };

        // --- Dark Mode ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                elements.darkModeToggle.checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                elements.darkModeToggle.checked = false;
            }
        };
        const toggleTheme = () => {
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        };

        // --- Import / Export ---
        const exportDataAsJSON = async () => {
             const allData = {
                projects: await getAllData('projects'),
                tasks: await getAllData('tasks'),
                accomplishments: await getAllData('accomplishments')
            };
            downloadFile(JSON.stringify(allData, null, 2), 'hub_tracker_backup.json', 'application/json');
        };
        const importDataFromJSON = (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData.projects) || !Array.isArray(importedData.tasks) || !Array.isArray(importedData.accomplishments)) throw new Error("Invalid file format.");
                    if (confirm("This will overwrite all current data. Are you sure?")) {
                        await Promise.all([clearData('projects'), clearData('tasks'), clearData('accomplishments')]);
                        await Promise.all(importedData.projects.map(p => addData('projects', p)));
                        await Promise.all(importedData.tasks.map(t => addData('tasks', t)));
                        await Promise.all(importedData.accomplishments.map(a => addData('accomplishments', a)));
                        alert("Data imported successfully!");
                        await loadData();
                        navigateTo('page-tracker');
                    }
                } catch (error) { alert("Failed to import data: " + error.message); } 
                finally { elements.importFileInput.value = null; }
            };
            reader.readAsText(file);
        };
        const exportTasksAsCSV = () => {
            const startDate = elements.csvDateStart.value;
            const endDate = elements.csvDateEnd.value;
            if(!startDate || !endDate) return alert("Please select a start and end date.");

            const startMs = new Date(startDate).getTime();
            const endMs = new Date(endDate).setHours(23, 59, 59, 999);
            
            const filteredTasks = tasks.filter(t => t.startTime >= startMs && t.startTime <= endMs);
            if(filteredTasks.length === 0) return alert("No tasks found in the selected date range.");

            const projectMap = new Map(projects.map(p => [p.id, p.name]));
            let csvContent = 'Project,Description,Notes,Date,Start Time,End Time,Duration (HH:MM:SS)\n';
            filteredTasks.forEach(t => {
                const sT = new Date(t.startTime), eT = new Date(t.endTime);
                const row = [
                    `"${projectMap.get(t.projectId) || 'Unknown'}"`,
                    `"${(t.description || '').replace(/"/g, '""')}"`,
                    `"${(t.notes || '').replace(/"/g, '""')}"`,
                    sT.toLocaleDateString(), sT.toLocaleTimeString(), eT.toLocaleTimeString(),
                    formatTime(t.endTime - t.startTime)
                ];
                csvContent += row.join(',') + '\n';
            });
            downloadFile(csvContent, `hub_tracker_export_${startDate}_to_${endDate}.csv`, 'text/csv;charset=utf-8;');
        };
        
        // --- Modal Logic ---
        const openModal = (modalEl) => {
            elements.modalBackdrop.classList.remove('hidden');
            modalEl.classList.remove('hidden');
        };
        const closeModal = (modalEl) => {
            elements.modalBackdrop.classList.add('hidden');
            modalEl.classList.add('hidden');
        };


        // --- Page Navigation ---
        const navigateTo = (pageId) => {
            elements.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
            elements.navButtons.forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
            if (pageId === 'page-reports') renderReportsPage('week');
            if (pageId === 'page-accomplishments') renderAccomplishmentsPage();
        };

        // --- Timer Logic ---
        const startTimerInterval = () => { if(timerInterval) clearInterval(timerInterval); timerInterval = setInterval(() => { if (activeTimer) { const el = document.querySelector(`.project-card.is-running .live-timer-display`); if(el) el.textContent = formatTime(Date.now() - activeTimer.startTime); updateDashboardTotalTime(); } }, 1000); };
        const stopTimerInterval = () => { clearInterval(timerInterval); timerInterval = null; };
        const startTimer = async (id) => { if(activeTimer) await stopTimer(); activeTimer={projectId:id,description:'', notes:'', startTime:Date.now()}; localStorage.setItem('activeTimerState', JSON.stringify(activeTimer)); startTimerInterval(); renderDashboardProjects(); };
        const stopTimer = async () => { 
            if (!activeTimer) return;
            const card = document.querySelector(`.project-card[data-project-id="${activeTimer.projectId}"]`);
            if (card) { activeTimer.description = card.querySelector('.task-description-input')?.value || ''; activeTimer.notes = card.querySelector('.task-notes-input')?.value || ''; }
            const t = { ...activeTimer, description: activeTimer.description || 'Untitled Task', endTime: Date.now() }; 
            t.id = await addData('tasks', t); tasks.push(t); 
            localStorage.removeItem('activeTimerState'); activeTimer = null; stopTimerInterval(); renderDashboardProjects(); updateDashboardTotalTime();
        };
        
        const saveNewProject = async () => {
            const name = elements.newProjectName.value.trim();
            if (!name) return alert("Project name cannot be empty.");
            
            const priority = elements.newProjectPriority.value;
            const color = elements.newProjectColor.value;
            
            const existingIds = projects.map(p => p.id).filter(id => typeof id === 'number');
            const newId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;

            const p = { id: newId, name, priority, color };
            
            await addData('projects', p); 
            projects.push(p); 
            renderDashboardProjects();
            closeModal(elements.addProjectModal);
            elements.newProjectName.value = "";
        };

        const updateProject = async (projectId, newName, newPriority, newColor) => {
            const project = projects.find(p => p.id === projectId);
            if(project) {
                project.name = newName;
                project.priority = newPriority;
                project.color = newColor;
                await updateData('projects', project);
                openProjectDetailView(projectId); // Refresh detail view
                renderDashboardProjects(); // Also refresh dashboard
            }
        };

        const updateDashboardTotalTime = () => {
            const dashboardTotalTimeEl = document.getElementById('dashboard-total-time');
            if(!dashboardTotalTimeEl) return;
            const startOfDay = new Date().setHours(0, 0, 0, 0);
            let totalMs = tasks
                .filter(t => t.endTime >= startOfDay)
                .reduce((sum, task) => sum + (task.endTime - task.startTime), 0);
            if (activeTimer) {
                totalMs += (Date.now() - activeTimer.startTime);
            }
            dashboardTotalTimeEl.textContent = formatDuration(totalMs);
        };

        // --- UI Rendering ---
        const renderDashboardProjects = () => {
            let sortedProjects = [...projects];

            if (currentSort === 'priority') {
                const priorityMap = { high: 3, medium: 2, low: 1, '': 0 };
                sortedProjects.sort((a, b) => priorityMap[b.priority] - priorityMap[a.priority] || a.name.localeCompare(b.name));
            } else if (currentSort === 'name') {
                sortedProjects.sort((a, b) => a.name.localeCompare(b.name));
            } else if (currentSort === 'latest') {
                 const latestActivityMap = new Map();
                 tasks.forEach(task => {
                     if (!latestActivityMap.has(task.projectId) || task.endTime > latestActivityMap.get(task.projectId)) {
                         latestActivityMap.set(task.projectId, task.endTime);
                     }
                 });
                 sortedProjects.sort((a, b) => {
                     const timeA = latestActivityMap.get(a.id) || 0;
                     const timeB = latestActivityMap.get(b.id) || 0;
                     return timeB - timeA;
                 });
            }

            elements.dashboardProjectsList.innerHTML = sortedProjects.map(p => {
                const isRunning = activeTimer?.projectId === p.id;
                const timeToday = getTodaysTimeForProject(p.id);
                
                const priorityBadgeHTML = p.priority ? `<div class="badge badge-priority-${p.priority}">${p.priority}</div>` : '';
                const startStopButton = `<button data-project-id="${p.id}" class="${isRunning ? 'stop-timer-btn bg-red-500' : 'start-timer-btn bg-gray-600'} text-white w-10 h-10 rounded-lg flex items-center justify-center transition-colors hover:bg-opacity-90 self-stretch"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">${isRunning ? '<path d="M6 6h12v12H6z"/>' : '<path d="M8 5v14l11-7z"/>'}</svg></button>`;

                const timeDisplayHTML = isRunning 
                    ? `<div class="text-xl font-bold text-green-500 timer-display live-timer-display">${formatTime(Date.now() - activeTimer.startTime)}</div>`
                    : `<div class="text-xl font-bold text-gray-400 dark:text-gray-500 timer-display">${timeToday}</div>`;

                const todaysTimeUnderTitleHTML = isRunning
                    ? `<div class="text-sm font-medium text-gray-500 dark:text-gray-400">Today: ${timeToday}</div>`
                    : '';

                const viewModeHTML = `
                    <div class="view-mode flex items-start justify-between">
                        <div class="flex items-start space-x-4 flex-grow min-w-0">
                            <span class="w-4 h-4 rounded-full flex-shrink-0 mt-1.5" style="background-color: ${p.color};"></span>
                            <div class="flex-grow min-w-0">
                                <div class="flex items-start space-x-2">
                                     <button class="font-semibold project-name-link truncate text-left hover:underline text-lg" data-project-id="${p.id}">${p.name}</button>
                                     ${priorityBadgeHTML}
                                </div>
                               ${todaysTimeUnderTitleHTML}
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            ${timeDisplayHTML}
                            ${startStopButton}
                        </div>
                    </div>`;

                const expandedContent = `<div class="expanded-content"><div><div class="pt-4 space-y-3"><input type="text" placeholder="What are you working on?" class="task-description-input w-full p-2 rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] text-[var(--foreground)] text-sm" value="${isRunning ? activeTimer.description : ''}"><textarea placeholder="Notes..." class="task-notes-input w-full p-2 rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] text-[var(--foreground)] text-sm h-20 resize-none">${isRunning ? activeTimer.notes : ''}</textarea></div></div></div>`;

                return `<div class="project-card bg-[var(--card)] rounded-xl shadow-sm border border-[var(--border)] p-4 transition-all duration-300 relative ${isRunning ? 'is-running' : ''}" style="--project-color: ${p.color}; --project-color-glow: ${p.color}40;" data-project-id="${p.id}">${viewModeHTML}${expandedContent}</div>`;
            }).join('');
        };
        
        // --- Reports Page Logic ---
        const renderReportsPage = (filter = 'week', range = {}) => {
            const now = new Date();
            let startDate, endDate;
            let titleDate = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

            if (filter === 'day') { startDate = new Date(now).setHours(0,0,0,0); endDate = new Date(now).setHours(23,59,59,999); }
            else if (filter === 'week') { const day = now.getDay(); const first = now.getDate() - day; startDate = new Date(new Date(now).setDate(first)).setHours(0,0,0,0); endDate = new Date(new Date(now).setDate(first + 6)).setHours(23,59,59,999); titleDate = `${new Date(startDate).toLocaleDateString([], {month:'short', day:'numeric'})} - ${new Date(endDate).toLocaleDateString([], {month:'short', day:'numeric', year: 'numeric'})}`; }
            else if (filter === 'month') { startDate = new Date(now.getFullYear(), now.getMonth(), 1).setHours(0,0,0,0); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0).setHours(23,59,59,999); titleDate = now.toLocaleDateString([], {month: 'long', year: 'numeric'}); }
            else if (filter === 'custom' && range.start && range.end) { startDate = new Date(range.start).getTime(); endDate = new Date(range.end).setHours(23,59,59,999); titleDate = `${new Date(startDate).toLocaleDateString([], {month:'short', day:'numeric'})} - ${new Date(endDate).toLocaleDateString([], {month:'short', day:'numeric', year: 'numeric'})}`; }
            
            const filteredTasks = tasks.filter(t => t.startTime >= startDate && t.startTime <= endDate);
            const totalMs = filteredTasks.reduce((sum, t) => sum + (t.endTime - t.startTime), 0);
            
            let contentHTML = `
                <div class="p-2 bg-[var(--muted)] rounded-xl flex items-center justify-between text-center text-sm font-semibold mb-4">
                    <button data-filter="day" class="reports-filter-btn flex-1 py-2 rounded-lg">Day</button>
                    <button data-filter="week" class="reports-filter-btn flex-1 py-2 rounded-lg bg-[var(--card)] shadow">Week</button>
                    <button data-filter="month" class="reports-filter-btn flex-1 py-2 rounded-lg">Month</button>
                    <button data-filter="custom" class="reports-filter-btn flex-1 py-2 rounded-lg">Custom</button>
                </div>
                <div class="bg-[var(--card)] p-3 rounded-xl border border-[var(--border)] mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span id="reports-date-display" class="font-semibold">${titleDate}</span>
                </div>
                <div class="bg-[var(--card)] p-4 rounded-xl border border-[var(--border)] mb-4">
                    <div class="flex justify-between items-center">
                        <div><p class="text-sm text-[var(--muted-foreground)]">Total Time</p><p class="text-xs text-[var(--muted-foreground)]/80">${new Date(startDate).toLocaleDateString([], {month:'short', day:'numeric'})}</p></div>
                        <div><p class="text-2xl font-bold">${formatDuration(totalMs)}</p><p class="text-xs text-[var(--muted-foreground)]/80 text-right">${filteredTasks.length} entries</p></div>
                    </div>
                </div>
                <div id="reports-entries-list" class="space-y-3"></div>`;
            
            elements.reportsContent.innerHTML = contentHTML;

            const listEl = document.getElementById('reports-entries-list');
            if (filteredTasks.length > 0) {
                 listEl.innerHTML = filteredTasks.sort((a,b) => b.startTime - a.startTime).map(t => {
                     const p = projects.find(proj => proj.id === t.projectId);
                     return `<div class="bg-[var(--card)] p-3 rounded-lg border border-[var(--border)] flex items-center justify-between">
                        <div>
                            <p class="font-semibold">${t.description}</p>
                            <p class="text-sm" style="color:${getBorderColorFromPriority(p?.priority)}">${p?.name || 'Unkown'}</p>
                        </div>
                        <div class="font-semibold">${formatDuration(t.endTime - t.startTime)}</div>
                     </div>`
                 }).join('');
            } else {
                listEl.innerHTML = `<div class="text-center py-10 bg-[var(--card)] rounded-lg border border-[var(--border)]"><div class="inline-block p-4 bg-[var(--muted)] rounded-full mb-2"><svg class="w-8 h-8 text-[var(--muted-foreground)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><p class="font-semibold">No time entries</p><p class="text-sm text-[var(--muted-foreground)]">No time was tracked during this period.</p></div>`
            }
        };

        // --- Accomplishments Page Logic ---
        const renderAccomplishmentsPage = () => {
            elements.accomplishmentProjectSelect.innerHTML = `<option value="">Select a project</option>` + projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            elements.accomplishmentText.value = '';
            
            elements.accomplishmentsList.innerHTML = accomplishments.sort((a,b) => b.date - a.date).map(acc => {
                const p = projects.find(proj => proj.id === acc.projectId);
                return `<div class="bg-[var(--card)] p-3 rounded-lg border border-[var(--border)]">
                    <p>${acc.text}</p>
                    <p class="text-xs text-[var(--muted-foreground)] mt-2 font-semibold" style="color: ${getBorderColorFromPriority(p?.priority) || 'gray'}">${p?.name || 'Unknown'} &bull; ${new Date(acc.date).toLocaleDateString()}</p>
                </div>`;
            }).join('');
        };
        const saveAccomplishment = async () => {
            const projectId = parseInt(elements.accomplishmentProjectSelect.value);
            const text = elements.accomplishmentText.value.trim();
            if (!projectId || !text) return alert("Please select a project and write your accomplishment.");

            const newAccomplishment = { projectId, text, date: Date.now() };
            newAccomplishment.id = await addData('accomplishments', newAccomplishment);
            accomplishments.push(newAccomplishment);
            renderAccomplishmentsPage();
        };

        // --- Detail View Logic ---
        const openProjectDetailView = (projectId) => {
            navigateTo('page-detail');
            currentDetailProjectId = projectId;
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const detailHTML = `
                <div id="project-detail-view-mode">
                    <header class="flex items-start justify-between mb-6">
                        <div>
                            <h1 class="text-2xl font-bold" style="color: ${getBorderColorFromPriority(project.priority)};">${project.name}</h1>
                            <p class="text-sm text-[var(--muted-foreground)]">Project Details & History</p>
                        </div>
                        <button id="edit-project-btn" class="text-sm font-semibold py-2 px-4 rounded-lg bg-[var(--muted)] hover:bg-[var(--muted)]/80">Edit</button>
                    </header>
                </div>
                <div id="project-detail-edit-mode" class="hidden mb-6 space-y-3 p-4 bg-[var(--muted)] rounded-lg">
                    <input type="text" id="edit-project-name" class="w-full p-2 text-xl font-bold border rounded-md bg-[var(--input-bg)] text-[var(--foreground)] border-[var(--input-border)]" value="${project.name}">
                    <div class="flex items-center gap-4">
                        <select id="edit-project-priority" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)] text-[var(--foreground)] border-[var(--input-border)]">
                            <option value="" ${!project.priority ? 'selected' : ''}>None</option>
                            <option value="low" ${project.priority === 'low' ? 'selected' : ''}>Low</option>
                            <option value="medium" ${project.priority === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="high" ${project.priority === 'high' ? 'selected' : ''}>High</option>
                        </select>
                        <input type="color" id="edit-project-color" value="${project.color}" class="h-10 p-1 border rounded-md bg-[var(--input-bg)] border-[var(--input-border)]">
                    </div>
                    <div class="flex justify-end gap-2">
                         <button id="cancel-edit-project-btn" class="text-sm font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
                         <button id="save-updated-project-btn" class="text-sm font-semibold px-4 py-2 rounded-lg bg-[var(--primary)] text-[var(--primary-foreground)]">Save Changes</button>
                    </div>
                </div>
                <div class="flex flex-wrap items-center gap-2 mb-4 p-2 bg-[var(--muted)] rounded-lg">
                    <div class="flex-grow flex space-x-1" id="detail-filter-buttons">
                        <button class="px-3 py-1 text-sm font-semibold rounded-md flex-grow filter-btn active bg-[var(--card)]" data-filter="today">Today</button>
                        <button class="px-3 py-1 text-sm font-semibold rounded-md flex-grow filter-btn" data-filter="week">Week</button>
                        <button class="px-3 py-1 text-sm font-semibold rounded-md flex-grow filter-btn" data-filter="month">Month</button>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <input type="date" id="date-range-start" class="p-1 border rounded-md text-xs bg-[var(--input-bg)] border-[var(--input-border)] text-[var(--foreground)]">
                        <span>to</span>
                        <input type="date" id="date-range-end" class="p-1 border rounded-md text-xs bg-[var(--input-bg)] border-[var(--input-border)] text-[var(--foreground)]">
                    </div>
                </div>
                <div class="mb-6 p-4 bg-[var(--card)] rounded-xl border border-[var(--border)]"><p class="text-sm text-[var(--muted-foreground)]">Total Time for Period</p><p id="detail-total-time" class="text-3xl font-bold">0h 0m</p></div>
                <div id="detail-entries-list" class="space-y-3"></div>
            `;
            elements.detailViewContent.innerHTML = detailHTML;
            renderProjectEntries(projectId, 'today');
        };
        
        const renderProjectEntries = (projectId, filter, range = {}) => {
            const now = new Date();
            let startDate, endDate;
            if (filter === 'today') { startDate = new Date().setHours(0,0,0,0); endDate = new Date().setHours(23,59,59,999); }
            else if (filter === 'week') { const day = now.getDay(); const first = now.getDate() - day; startDate = new Date(new Date().setDate(first)).setHours(0,0,0,0); endDate = new Date(new Date().setDate(first + 6)).setHours(23,59,59,999); }
            else if (filter === 'month') { startDate = new Date(now.getFullYear(), now.getMonth(), 1).setHours(0,0,0,0); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0).setHours(23,59,59,999); }
            else if (filter === 'range' && range.start && range.end) { startDate = new Date(range.start).getTime(); endDate = new Date(range.end).setHours(23,59,59,999); }
            
            const filteredTasks = tasks.filter(t => t.projectId === projectId && t.startTime >= startDate && t.startTime <= endDate).sort((a,b) => b.startTime - a.startTime);
            const totalMs = filteredTasks.reduce((sum, t) => sum + (t.endTime - t.startTime), 0);

            const totalTimeEl = document.getElementById('detail-total-time');
            if(totalTimeEl) totalTimeEl.textContent = formatDuration(totalMs);
            
            const listEl = document.getElementById('detail-entries-list');
            if(listEl) listEl.innerHTML = filteredTasks.length > 0 ? filteredTasks.map(createTaskEntryHTML).join('') : `<p class="text-center text-[var(--muted-foreground)] p-4">No entries found for this period.</p>`;
        };

        const createTaskEntryHTML = (task) => {
            const sT = new Date(task.startTime), eT = new Date(task.endTime);
            const duration = formatDuration(task.endTime - task.startTime);
            const dateStr = sT.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
            const timeStr = `${sT.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${eT.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;

            return `
            <div class="task-entry bg-[var(--card)] p-3 rounded-lg border border-[var(--border)]" data-task-id="${task.id}">
                <div class="view-mode">
                    <p class="font-semibold">${task.description}</p>
                    <p class="text-sm text-[var(--muted-foreground)] whitespace-pre-wrap">${task.notes || 'No notes'}</p>
                    <div class="flex justify-between items-center mt-2 text-sm">
                        <div class="text-[var(--muted-foreground)]">${dateStr} &bull; ${timeStr}</div>
                        <div class="flex items-center gap-4">
                            <span class="font-semibold">${duration}</span>
                            <button class="edit-task-btn text-xs font-semibold text-blue-600 hover:underline">Edit</button>
                            <button class="delete-task-btn text-xs font-semibold text-red-600 hover:underline">Delete</button>
                        </div>
                    </div>
                </div>
                <div class="edit-mode hidden space-y-2">
                    <input class="w-full p-2 text-sm border rounded-md bg-[var(--input-bg)] text-[var(--foreground)] border-[var(--input-border)]" value="${task.description}">
                    <textarea class="w-full p-2 text-sm border rounded-md h-20 bg-[var(--input-bg)] text-[var(--foreground)] border-[var(--input-border)]">${task.notes}</textarea>
                    <div class="flex items-center gap-2">
                        <input type="date" class="w-full p-1 text-xs border rounded-md bg-[var(--input-bg)] text-[var(--foreground)] border-[var(--input-border)]" value="${sT.toISOString().split('T')[0]}">
                        <input type="time" class="w-full p-1 text-xs border rounded-md bg-[var(--input-bg)] text-[var(--foreground)] border-[var(--input-border)]" value="${sT.toTimeString().slice(0,5)}">
                        <input type="time" class="w-full p-1 text-xs border rounded-md bg-[var(--input-bg)] text-[var(--foreground)] border-[var(--input-border)]" value="${eT.toTimeString().slice(0,5)}">
                    </div>
                    <div class="flex justify-end gap-2">
                         <button class="cancel-edit-btn px-3 py-1 text-xs font-semibold bg-gray-200 dark:bg-gray-700 rounded-md">Cancel</button>
                         <button class="save-task-btn px-3 py-1 text-xs font-semibold text-white bg-blue-600 rounded-md">Save</button>
                    </div>
                </div>
            </div>`;
        };
        
        // --- Event Handlers ---
        elements.addProjectBtn.onclick = () => openModal(elements.addProjectModal);
        elements.cancelAddProjectBtn.onclick = () => closeModal(elements.addProjectModal);
        elements.saveProjectBtn.onclick = saveNewProject;
        elements.saveAccomplishmentBtn.onclick = saveAccomplishment;
        elements.darkModeToggle.onchange = toggleTheme;
        elements.importJsonBtn.onclick = () => elements.importFileInput.click();
        elements.importFileInput.onchange = importDataFromJSON;
        elements.exportJsonBtn.onclick = exportDataAsJSON;
        elements.exportCsvBtn.onclick = exportTasksAsCSV;

        document.getElementById('app-container').addEventListener('click', e => {
            const reportsFilterBtn = e.target.closest('.reports-filter-btn');
            if(reportsFilterBtn) {
                document.querySelectorAll('.reports-filter-btn').forEach(b => b.classList.remove('bg-[var(--card)]', 'shadow'));
                reportsFilterBtn.classList.add('bg-[var(--card)]', 'shadow');
                renderReportsPage(reportsFilterBtn.dataset.filter);
            }
        });
        
        elements.dashboardProjectsList.addEventListener('click', e => {
            const startBtn = e.target.closest('.start-timer-btn');
            const stopBtn = e.target.closest('.stop-timer-btn');
            const nameLink = e.target.closest('.project-name-link');
            const card = e.target.closest('.project-card');
            
            if (startBtn) startTimer(parseInt(card.dataset.projectId));
            else if (stopBtn) stopTimer();
            else if (nameLink) openProjectDetailView(parseInt(nameLink.dataset.projectId));
        });

        elements.dashboardProjectsList.addEventListener('input', e => {
            if (!activeTimer) return;
            const target = e.target;
            if (target.matches('.task-description-input')) {
                activeTimer.description = target.value;
            } else if (target.matches('.task-notes-input')) {
                activeTimer.notes = target.value;
            }
            localStorage.setItem('activeTimerState', JSON.stringify(activeTimer));
        });

        elements.detailViewContent.addEventListener('click', async e => {
            if (e.target.closest('#edit-project-btn')) {
                document.getElementById('project-detail-view-mode').classList.add('hidden');
                document.getElementById('project-detail-edit-mode').classList.remove('hidden');
            }
            if (e.target.closest('#cancel-edit-project-btn')) {
                document.getElementById('project-detail-view-mode').classList.remove('hidden');
                document.getElementById('project-detail-edit-mode').classList.add('hidden');
            }
            if(e.target.closest('#save-updated-project-btn')){
                const newName = document.getElementById('edit-project-name').value;
                const newPriority = document.getElementById('edit-project-priority').value;
                const newColor = document.getElementById('edit-project-color').value;
                await updateProject(currentDetailProjectId, newName, newPriority, newColor);
            }
            
            const filterBtn = e.target.closest('#detail-filter-buttons .filter-btn');
            if(filterBtn) {
                document.querySelectorAll('#detail-filter-buttons .filter-btn').forEach(b => b.classList.remove('active', 'bg-[var(--card)]'));
                filterBtn.classList.add('active', 'bg-[var(--card)]');
                renderProjectEntries(currentDetailProjectId, filterBtn.dataset.filter);
            }

            const entryEl = e.target.closest('.task-entry');
            if (!entryEl) return;
            const taskId = parseInt(entryEl.dataset.taskId);

            if (e.target.closest('.delete-task-btn')) {
                if (confirm('Are you sure you want to delete this entry?')) {
                    await deleteData('tasks', taskId);
                    tasks = tasks.filter(t => t.id !== taskId);
                    const currentFilter = document.querySelector('#detail-filter-buttons .filter-btn.active').dataset.filter;
                    renderProjectEntries(currentDetailProjectId, currentFilter);
                }
            } else if (e.target.closest('.edit-task-btn')) {
                entryEl.querySelector('.view-mode').classList.add('hidden');
                entryEl.querySelector('.edit-mode').classList.remove('hidden');
            } else if (e.target.closest('.cancel-edit-btn')) {
                entryEl.querySelector('.view-mode').classList.remove('hidden');
                entryEl.querySelector('.edit-mode').classList.add('hidden');
            } else if (e.target.closest('.save-task-btn')) {
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;
                const inputs = entryEl.querySelectorAll('.edit-mode input, .edit-mode textarea');
                task.description = inputs[0].value;
                task.notes = inputs[1].value;
                const newDate = inputs[2].value;
                task.startTime = new Date(`${newDate}T${inputs[3].value}`).getTime();
                task.endTime = new Date(`${newDate}T${inputs[4].value}`).getTime();

                await updateData('tasks', task);
                const currentFilter = document.querySelector('#detail-filter-buttons .filter-btn.active').dataset.filter;
                renderProjectEntries(currentDetailProjectId, currentFilter);
            }
        });

        elements.detailViewContent.addEventListener('change', e => {
             if (e.target.matches('#date-range-start') || e.target.matches('#date-range-end')) {
                const startEl = document.getElementById('date-range-start');
                const endEl = document.getElementById('date-range-end');
                if(startEl && endEl && startEl.value && endEl.value) {
                    document.querySelectorAll('#detail-filter-buttons .filter-btn').forEach(b => b.classList.remove('active', 'bg-[var(--card)]'));
                    renderProjectEntries(currentDetailProjectId, 'range', {start: startEl.value, end: endEl.value});
                }
             }
        });

        elements.navButtons.forEach(b => b.addEventListener('click', () => navigateTo(b.dataset.page)));
        
        elements.sortControls.addEventListener('click', e => {
            const sortBtn = e.target.closest('.sort-btn');
            if(!sortBtn) return;

            elements.sortControls.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            sortBtn.classList.add('active');
            currentSort = sortBtn.dataset.sort;
            renderDashboardProjects();
        });
        
        // --- Initialization ---
        const initializeApp = () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            loadData(); 
            checkPersistentTimer(); 
        };
        initializeApp();
    });
    </script>
</body>
</html>

