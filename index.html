<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>the work app</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#030213">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⏱️</text></svg>">
    <script src="https://cdn.tailwindcss.com/3.4.1?plugins=typography"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --background: #f5f2f0; --foreground: #111827; --card: #ffffff;
            --primary: #030213; --primary-foreground: #ffffff; --muted: #e5e7eb; --muted-foreground: #6b7280;
            --border: #e5e7eb; --input-border: #d1d5db; --input-bg: #ffffff;
            --coral: #ff7f50; --coral-dark: #e66a3f; --coral-light: #fff0e6;
        }
        .dark {
            --background: #1c1a19; --foreground: #fafafa; --card: #312e2c;
            --primary: #fafafa; --primary-foreground: #09090b; --muted: #3a3634; --muted-foreground: #a1a1aa;
            --border: #3a3634; --input-border: #524c4a; --input-bg: #2a2726;
            --coral-light: #443229;
        }
        html { scroll-padding-bottom: 90px; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background); color: var(--foreground); padding-bottom: 90px; }
        @media (min-width: 1024px) {
            body { padding-bottom: 0; }
        }
        .timer-display { font-variant-numeric: tabular-nums; }
        .expanded-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.4s ease-in-out; } .expanded-content > div { overflow: hidden; } .project-card.is-running .expanded-content { grid-template-rows: 1fr; }
        .page { display: none; } .page.active { display: block; }
        #bottom-nav button.active { background-color: var(--coral-light); }
        #desktop-nav button.active { background-color: var(--coral-light); }
        #bottom-nav button i, #desktop-nav button i { color: var(--coral); }
        .sort-btn.active { background-color: var(--coral); color: white; }
        .dark input[type="date"], .dark input[type="time"] { color-scheme: dark; }
        input.toggle-checkbox:checked ~ .dot { transform: translateX(100%); background-color: var(--primary); }
        .project-card.is-running { border-color: transparent; box-shadow: 0 0 0 2px var(--project-color, var(--border)), 0 4px 12px 0 rgba(0,0,0,0.1); } .dark .project-card.is-running { box-shadow: 0 0 0 2px var(--project-color, var(--border)), 0 0 20px 0 var(--project-color-glow, rgba(255,255,255,0.1)); }
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 40; } .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; }
        .progress-bar-bg { background-color: var(--muted); height: 4px; border-radius: 99px; overflow: hidden; } .progress-bar-fg { height: 100%; transition: width 0.5s ease; }
        .tag { background-color: var(--muted); color: var(--muted-foreground); padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 500; }
        .color-swatch { width: 2rem; height: 2rem; border-radius: 9999px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s; }
        .color-swatch.selected { border-color: var(--primary); transform: scale(1.1); }
        .custom-task-dropdown { position: absolute; top: 100%; left:0; right: 0; max-height: 150px; overflow-y: auto; background-color: var(--card); border: 1px solid var(--border); border-radius: 0.5rem; z-index: 10; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        footer { padding-bottom: env(safe-area-inset-bottom, 1rem); background-color: #edeae8; }
        .dark footer { background-color: #1a1817; }
        .timer-control-btn i { transition: transform 0.2s; }
        .timer-control-btn:active i { transform: scale(0.9); }
        .start-timer-btn { background-color: #22c55e !important; color: white !important; }
        .sort-by-text { color: var(--coral); }
        .dark .sort-by-text { color: var(--coral); }

        /* Animation Styles */
        .project-card-placeholder {
            border-radius: 1rem;
            transition: all 0.4s ease-in-out;
            flex-shrink: 0;
        }
        #dashboard-section {
            position: relative;
        }
        #dashboard-projects-list.card-focused-mode .project-card:not(.is-focused) {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
            transition-delay: 0s;
        }
        .project-card {
            position: relative;
            z-index: 1;
            transition: transform 0.4s cubic-bezier(0.645, 0.045, 0.355, 1), 
                        opacity 0.4s cubic-bezier(0.645, 0.045, 0.355, 1);
        }
        .project-card.is-focused {
            z-index: 50;
        }
        
        body.focus-mode-active #desktop-nav,
        body.focus-mode-active #add-project-btn-container,
        body.focus-mode-active #sort-controls-container,
        body.focus-mode-active #dashboard-footer-controls,
        body.focus-mode-active footer {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        .is-focused-header {
            opacity: 1 !important;
            pointer-events: auto !important;
        }


    </style>
</head>
<body class="bg-[var(--background)]">
    
    <div class="lg:flex">
        <!-- Desktop Sidebar Navigation -->
        <div class="hidden lg:flex flex-col w-64 border-r border-[var(--border)] bg-[var(--card)] p-4 flex-shrink-0 h-screen sticky top-0">
            <div class="flex items-center space-x-3 mb-8 px-2">
                <div class="bg-black text-white w-8 h-8 flex items-center justify-center rounded-full flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                </div>
                <div><h1 class="text-xl font-bold text-[var(--foreground)]">the work app</h1></div>
            </div>
            <nav id="desktop-nav" class="flex-grow flex flex-col space-y-2">
                <button data-page="page-tracker" class="nav-btn flex items-center space-x-4 p-3 rounded-lg text-left font-semibold text-[var(--foreground)]">
                    <i class="fa-solid fa-clock w-6 text-center text-xl"></i>
                    <span>Tracker</span>
                </button>
                <button data-page="page-tasks" class="nav-btn flex items-center space-x-4 p-3 rounded-lg text-left font-semibold text-[var(--foreground)]">
                    <i class="fa-solid fa-list-check w-6 text-center text-xl"></i>
                    <span>Tasks</span>
                </button>
                <button data-page="page-reports" class="nav-btn flex items-center space-x-4 p-3 rounded-lg text-left font-semibold text-[var(--foreground)]">
                    <i class="fa-solid fa-chart-simple w-6 text-center text-xl"></i>
                    <span>Reports</span>
                </button>
                <button data-page="page-accomplishments" class="nav-btn flex items-center space-x-4 p-3 rounded-lg text-left font-semibold text-[var(--foreground)]">
                   <i class="fa-solid fa-award w-6 text-center text-xl"></i>
                   <span>Accomplishments</span>
                </button>
                <button data-page="page-settings" class="nav-btn flex items-center space-x-4 p-3 rounded-lg text-left font-semibold text-[var(--foreground)]">
                   <i class="fa-solid fa-gear w-6 text-center text-xl"></i>
                   <span>Settings</span>
                </button>
            </nav>
        </div>

        <!-- Main App Container -->
        <div id="app-container" class="flex-grow">
            
            <header class="sticky top-0 bg-[var(--background)]/80 backdrop-blur-sm z-10 lg:hidden">
                <div class="container mx-auto p-4 sm:p-6">
                     <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <div class="bg-black text-white w-8 h-8 flex items-center justify-center rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                            </div>
                            <div><h1 class="text-xl font-bold text-[var(--foreground)]">the work app</h1></div>
                        </div>
                    </div>
                </div>
            </header>

            <main>
                <div id="page-tracker" class="page active">
                    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <div>
                                <h1 class="text-2xl font-bold" style="color: var(--coral-dark);">Projects</h1>
                                <p id="tracker-date-display" class="text-sm text-gray-400"></p>
                            </div>
                            <div id="add-project-btn-container">
                                 <button id="add-project-btn-dashboard" class="bg-[var(--coral)] text-white w-12 h-12 flex items-center justify-center rounded-full shadow-lg hover:bg-opacity-90 transition-transform transform hover:scale-105">
                                    <i class="fa-solid fa-plus text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <div id="sort-controls-container">
                            <div class="flex flex-wrap items-center justify-between my-4 p-2 rounded-lg gap-4" style="background-color: var(--coral-light);">
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm font-semibold ml-2 sort-by-text">Sort by:</span>
                                    <button data-sort="latest" class="sort-btn text-xs font-semibold px-3 py-1 rounded-full active">Recent</button>
                                    <button data-sort="name" class="sort-btn text-xs font-semibold px-3 py-1 rounded-full">Name</button>
                                    <button data-sort="time" data-dir="desc" class="sort-btn text-xs font-semibold px-3 py-1 rounded-full inline-flex items-center gap-1">Timer Amount <span class="sort-arrow"></span></button>
                                </div>
                                <div class="text-sm text-right pr-2">
                                    <span class="font-medium text-[var(--foreground)]">Today:</span>
                                    <span id="dashboard-total-time" class="font-bold text-[var(--foreground)] timer-display"></span>
                                </div>
                            </div>
                        </div>
                        <section id="dashboard-section">
                            <div id="dashboard-projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                             <div id="dashboard-footer-controls" class="text-center mt-6">
                                <button id="view-completed-projects-btn" class="text-sm font-semibold text-gray-500 hover:underline">View Completed Projects</button>
                            </div>
                        </section>
                    </div>
                </div>
                
                <div id="page-tasks" class="page"><div id="tasks-content" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl"></div></div>
                <div id="page-reports" class="page"><div id="reports-content" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl"></div></div>
                <div id="page-accomplishments" class="page"><div id="accomplishments-content" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl"></div></div>
                <div id="page-settings" class="page"><div id="settings-content" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl"></div></div>
                <div id="page-detail" class="page"><div id="detail-view-content" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl"></div></div>
                <div id="page-completed-projects" class="page"><div id="completed-projects-content" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl"></div></div>
            </main>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <footer class="fixed bottom-0 left-0 right-0 z-10 border-t border-[var(--border)] lg:hidden">
         <nav id="bottom-nav" class="flex justify-around max-w-6xl mx-auto px-2 pb-2">
            <button data-page="page-tracker" class="nav-btn flex-1 py-3 flex items-center justify-center text-gray-500 rounded-lg m-1">
                <i class="fa-solid fa-clock text-xl"></i>
            </button>
            <button data-page="page-tasks" class="nav-btn flex-1 py-3 flex items-center justify-center text-gray-500 rounded-lg m-1">
                <i class="fa-solid fa-list-check text-xl"></i>
            </button>
            <button data-page="page-reports" class="nav-btn flex-1 py-3 flex items-center justify-center text-gray-500 rounded-lg m-1">
                <i class="fa-solid fa-chart-simple text-xl"></i>
            </button>
            <button data-page="page-accomplishments" class="nav-btn flex-1 py-3 flex items-center justify-center text-gray-500 rounded-lg m-1">
               <i class="fa-solid fa-award text-xl"></i>
            </button>
            <button data-page="page-settings" class="nav-btn flex-1 py-3 flex items-center justify-center text-gray-500 rounded-lg m-1">
               <i class="fa-solid fa-gear text-xl"></i>
            </button>
         </nav>
    </footer>

    <!-- Modals -->
    <div id="modal-backdrop" class="modal-backdrop hidden"></div>
    <div id="add-project-modal" class="modal hidden w-11/12 max-w-md">
         <form id="add-project-form" class="bg-[var(--card)] rounded-lg shadow-xl border border-[var(--border)] p-6 space-y-4">
            <h2 class="text-xl font-bold" style="color:var(--coral);">New Project</h2>
            <div>
                <label for="new-project-name" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Project Name</label>
                <input type="text" id="new-project-name" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)] text-[var(--foreground)] border-[var(--input-border)]" placeholder="e.g., Q4 Marketing Campaign" required>
            </div>
             <div>
                <label for="new-project-description" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Description</label>
                <textarea id="new-project-description" rows="2" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)] text-[var(--foreground)] border-[var(--input-border)]" placeholder="Brief project description..."></textarea>
            </div>
            <div>
                 <label class="block text-sm font-medium text-[var(--muted-foreground)] mb-2">Color</label>
                 <div id="color-palette" class="flex flex-wrap gap-3"></div>
                 <input type="hidden" id="new-project-color">
            </div>
             <div>
                <label for="new-project-estimate" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Time Estimate (hours)</label>
                <input type="number" id="new-project-estimate" step="0.1" min="0" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)] text-[var(--foreground)] border-[var(--input-border)]" placeholder="e.g., 40">
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t border-[var(--border)]">
                <button type="button" id="cancel-add-project-btn" class="px-5 py-2 text-base font-semibold rounded-lg hover:bg-[var(--muted)]">Cancel</button>
                <button type="submit" id="save-project-btn" class="px-5 py-2 text-base font-semibold text-white rounded-lg" style="background-color: var(--coral);">Save Project</button>
            </div>
        </form>
    </div>
    <div id="add-predefined-task-modal" class="modal hidden w-11/12 max-w-md">
         <form id="add-predefined-task-form" class="bg-[var(--card)] rounded-lg shadow-xl border border-[var(--border)] p-6 space-y-4">
            <h2 id="predefined-task-modal-title" class="text-xl font-bold">New Task</h2>
            <input type="hidden" id="predefined-task-id">
            <div>
                <label for="predefined-task-desc" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Task Name / Description</label>
                <input type="text" id="predefined-task-desc" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]" required>
            </div>
            <div>
                <label for="predefined-task-project" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Project</label>
                <select id="predefined-task-project" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]"></select>
            </div>
            <div>
                <label for="predefined-task-due-date" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Due Date</label>
                <input type="date" id="predefined-task-due-date" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]">
            </div>
             <div>
                <label for="predefined-task-notes" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Notes</label>
                <textarea id="predefined-task-notes" rows="2" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]"></textarea>
            </div>
             <div>
                <label for="predefined-task-tags" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Tags (comma separated)</label>
                <input type="text" id="predefined-task-tags" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]">
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t border-[var(--border)]">
                <button type="button" id="cancel-add-predefined-task-btn" class="px-5 py-2 text-base font-semibold rounded-lg hover:bg-[var(--muted)]">Cancel</button>
                <button type="submit" class="px-5 py-2 text-base font-semibold text-white bg-blue-600 rounded-lg">Save Task</button>
            </div>
        </form>
    </div>
    <div id="add-accomplishment-modal" class="modal hidden w-11/12 max-w-md">
        <form id="add-accomplishment-form" class="bg-[var(--card)] rounded-lg shadow-xl border border-[var(--border)] p-6 space-y-4">
            <h2 id="accomplishment-modal-title" class="text-xl font-bold">Log an Accomplishment</h2>
            <input type="hidden" id="accomplishment-id">
            <div>
                <label for="accomplishment-project-select" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Project</label>
                <select id="accomplishment-project-select" class="w-full p-2 border border-[var(--input-border)] rounded-md bg-[var(--input-bg)] text-[var(--foreground)]"></select>
            </div>
             <div>
                <label for="accomplishment-date" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Date</label>
                <input type="date" id="accomplishment-date" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]">
            </div>
            <div>
                <label for="accomplishment-text" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Accomplishment</label>
                <textarea id="accomplishment-text" placeholder="What did you accomplish today?" class="w-full p-2 border border-[var(--input-border)] rounded-md h-24 bg-[var(--input-bg)] text-[var(--foreground)]"></textarea>
            </div>
            <div>
                <label for="accomplishment-tags" class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Tags</label>
                <input type="text" id="accomplishment-tags" placeholder="Add tags... (#milestone)" class="w-full p-2 border border-[var(--input-border)] rounded-md text-sm bg-[var(--input-bg)] text-[var(--foreground)]">
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t border-[var(--border)]">
                <button type="button" id="cancel-add-accomplishment-btn" class="px-5 py-2 text-base font-semibold rounded-lg hover:bg-[var(--muted)]">Cancel</button>
                <button type="submit" class="px-5 py-2 text-base w-full text-white font-semibold rounded-md" style="background-color: var(--coral);">Save</button>
            </div>
        </form>
    </div>
    <div id="guide-modal" class="modal hidden w-11/12 max-w-2xl">
        <div class="bg-[var(--card)] rounded-lg shadow-xl border border-[var(--border)] p-6 max-h-[80vh] overflow-y-auto">
            <div id="guide-content"></div>
            <button id="close-guide-btn" class="mt-4 w-full px-4 py-2 font-semibold rounded-lg bg-[var(--muted)]">Close</button>
        </div>
    </div>
    <div id="manual-entry-modal" class="modal hidden w-11/12 max-w-md">
         <form id="manual-entry-form" class="bg-[var(--card)] rounded-lg shadow-xl border border-[var(--border)] p-6 space-y-4">
            <h2 class="text-xl font-bold">Add Manual Time Entry</h2>
            <div>
                <label class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Description</label>
                <input type="text" id="manual-entry-desc" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Date</label>
                <input type="date" id="manual-entry-date" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]" required>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Start Time</label>
                    <input type="time" id="manual-entry-start" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">End Time</label>
                    <input type="time" id="manual-entry-end" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]" required>
                </div>
            </div>
             <div>
                <label class="block text-sm font-medium text-[var(--muted-foreground)] mb-1">Notes</label>
                <textarea id="manual-entry-notes" rows="4" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]" placeholder="Add notes here..."></textarea>
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t">
                <button type="button" id="cancel-manual-entry-btn" class="px-5 py-2 text-base font-semibold rounded-lg hover:bg-[var(--muted)]">Cancel</button>
                <button type="submit" class="px-5 py-2 text-base font-semibold text-white bg-blue-600 rounded-lg">Save Entry</button>
            </div>
        </form>
    </div>
    
    <!-- Templates -->
    <template id="accomplishments-page-template">
        <div class="flex justify-between items-center mb-2">
            <div>
                 <h1 class="text-2xl font-bold" style="color:var(--coral-dark);">Accomplishments</h1>
                 <p id="accomplishments-date-display" class="text-sm text-gray-400"></p>
            </div>
            <button id="add-accomplishment-btn" class="bg-[var(--coral)] text-white w-10 h-10 flex items-center justify-center rounded-full shadow-lg hover:bg-opacity-90 transition-transform transform hover:scale-105">
                <i class="fa-solid fa-plus text-lg"></i>
            </button>
        </div>
        <div id="accomplishments-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4"></div>
    </template>
    <template id="tasks-page-template">
        <div class="flex justify-between items-center mb-2">
             <div>
                <h1 class="text-2xl font-bold" style="color:var(--coral-dark);">Tasks</h1>
                <p class="text-[var(--muted-foreground)]">Manage reusable tasks for your projects.</p>
            </div>
            <button id="add-predefined-task-btn" class="bg-[var(--coral)] text-white w-10 h-10 flex items-center justify-center rounded-full shadow-lg hover:bg-opacity-90 transition-transform transform hover:scale-105">
                <i class="fa-solid fa-plus text-lg"></i>
            </button>
        </div>
        <div id="predefined-tasks-list" class="space-y-4 mt-4"></div>
    </template>
    <template id="reports-page-template">
         <div class="flex flex-wrap justify-between items-center mb-2 gap-4">
            <div>
                 <h1 class="text-2xl font-bold" style="color:var(--coral-dark);">Reports</h1>
                 <p id="reports-date-display" class="text-sm text-gray-400"></p>
            </div>
            <button id="export-day-notes-btn" class="hidden bg-[var(--coral)] text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md hover:bg-opacity-90">Export Day Notes</button>
        </div>
         <div class="flex flex-wrap items-center gap-4">
            <div class="p-2 bg-[var(--muted)] rounded-xl flex text-center text-sm font-semibold my-4">
                <button data-filter="day" class="reports-filter-btn flex-1 py-2 px-4 rounded-lg">Day</button>
                <button data-filter="week" class="reports-filter-btn flex-1 py-2 px-4 rounded-lg bg-[var(--card)] shadow">Week</button>
                <button data-filter="month" class="reports-filter-btn flex-1 py-2 px-4 rounded-lg">Month</button>
                <button data-filter="custom" class="reports-filter-btn flex-1 py-2 px-4 rounded-lg">Custom</button>
            </div>
            <div id="reports-day-picker-container" class="hidden">
                 <input type="date" id="reports-day-picker" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]">
            </div>
        </div>
        <div id="reports-custom-range" class="hidden flex items-center gap-2 text-sm mb-4">
            <input type="date" id="reports-date-start" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]">
            <span class="text-[var(--muted-foreground)]">to</span>
            <input type="date" id="reports-date-end" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]">
        </div>
        <div class="mb-6 p-4 bg-[var(--card)] rounded-xl border">
            <p class="text-sm text-[var(--muted-foreground)]">Total Time for Period</p>
            <p id="reports-total-time" class="text-3xl font-bold">0h 0m</p>
        </div>
        <div id="reports-summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </template>
    <template id="settings-template">
         <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold">Settings</h1>
        </div>
        <div class="space-y-6">
            <div class="bg-[var(--card)] p-4 rounded-lg border border-[var(--border)]">
                <h2 class="text-lg font-semibold mb-3">Appearance</h2>
                <div class="flex items-center justify-between">
                    <span class="font-medium">Dark Mode</span>
                    <label for="dark-mode-toggle" class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" id="dark-mode-toggle" class="sr-only toggle-checkbox"><div class="block bg-gray-300 dark:bg-gray-600 w-12 h-6 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div></div></label>
                </div>
            </div>
             <div class="bg-[var(--card)] p-4 rounded-lg border border-[var(--border)]">
                <h2 class="text-lg font-semibold mb-3">Time & Region</h2>
                <div class="flex items-center justify-between">
                    <span class="font-medium">Detected Time Zone</span>
                    <span id="detected-time-zone" class="font-semibold text-sm bg-[var(--muted)] px-2 py-1 rounded-md"></span>
                </div>
                 <p class="text-xs text-[var(--muted-foreground)] mt-2">All times are calculated based on your device's local time settings.</p>
            </div>
            <div class="bg-[var(--card)] p-4 rounded-lg border border-[var(--border)] space-y-3">
                <h2 class="text-lg font-semibold">Data Management</h2>
                <div class="flex items-center justify-between">
                    <div>
                        <label for="auto-backup-toggle" class="font-medium">Automatic Daily Backup</label>
                        <p id="last-backup-info" class="text-xs text-[var(--muted-foreground)]">Backs up at 12:00 PM daily.</p>
                    </div>
                    <label for="auto-backup-toggle" class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" id="auto-backup-toggle" class="sr-only toggle-checkbox"><div class="block bg-gray-300 dark:bg-gray-600 w-12 h-6 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div></div></label>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 pt-2">
                    <button id="import-json-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold border border-[var(--input-border)] hover:bg-[var(--muted)]">Import from JSON</button>
                    <button id="export-json-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold border border-[var(--input-border)] hover:bg-[var(--muted)]">Export to JSON</button>
                </div>
                <input type="file" id="import-file-input" class="hidden" accept="application/json">
            </div>
            <div class="bg-[var(--card)] p-4 rounded-lg border border-[var(--border)] space-y-3">
                <h2 class="text-lg font-semibold">Export CSV Report</h2>
                <div class="flex items-center gap-2 text-sm">
                    <input type="date" id="csv-date-start" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)] border-[var(--input-border)] text-[var(--foreground)]">
                    <span>to</span>
                    <input type="date" id="csv-date-end" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)] border-[var(--input-border)] text-[var(--foreground)]">
                </div>
                <button id="export-csv-btn" class="w-full bg-[var(--primary)] text-[var(--primary-foreground)] font-semibold py-2 rounded-md">Export CSV</button>
            </div>
            <div class="bg-[var(--card)] p-4 rounded-lg border border-[var(--border)] space-y-3">
                <h2 class="text-lg font-semibold">About</h2>
                 <p class="text-sm text-[var(--muted-foreground)]">This is a PWA-ready application. To make it installable, create the `manifest.json` and `sw.js` files as instructed in the source code comments.</p>
                <button id="show-guide-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold border border-[var(--input-border)] hover:bg-[var(--muted)]">Show User Guide</button>
            </div>
        </div>
    </template>

    <script>
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered.'), err => console.log('SW registration failed: ', err)); }); }

    document.addEventListener('DOMContentLoaded', () => {
        let projects = [], tasks = [], accomplishments = [], predefinedTasks = [], activeTimer = null, timerInterval = null;
        let currentDetailProjectId = null, currentSort = 'latest';
        let dom = {};
        let focusedCardState = null;
        let isAnimating = false;

        const PALETTE = ['#ef4444', '#f97316', '#f59e0b', '#22c55e', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef', '#ec4899', '#14b8a6'];

        const formatTime=(ms)=>new Date(ms).toISOString().slice(11,19);
        const formatDuration=(ms)=>{if(ms<0)ms=0;const tM=Math.floor(ms/60000);if(tM<1)return"0m";const h=Math.floor(tM/60);const m=tM%60;return`${h>0?`${h}h `:''}${m}m`;};
        const getTotalTimeForProject=(id)=>{let t=tasks.filter(t=>t.projectId===id).reduce((s,t)=>s+(t.endTime-t.startTime),0);if(activeTimer&&activeTimer.projectId===id){let elapsed;if(activeTimer.isPaused){elapsed=activeTimer.pauseStartTime-activeTimer.startTime-activeTimer.totalPausedTime;}else{elapsed=Date.now()-activeTimer.startTime-activeTimer.totalPausedTime;}t+=elapsed>0?elapsed:0;}return t;};
        const getTodaysTimeForProjectMs=(projectId)=>{const startOfDay=new Date().setHours(0,0,0,0);let totalMs=tasks.filter(t=>t.projectId===projectId&&t.endTime>=startOfDay).reduce((sum,task)=>sum+(task.endTime-task.startTime),0);if(activeTimer&&activeTimer.projectId===projectId){let elapsed;if(activeTimer.isPaused){elapsed=activeTimer.pauseStartTime-activeTimer.startTime-activeTimer.totalPausedTime;}else{elapsed=Date.now()-activeTimer.startTime-activeTimer.totalPausedTime;}const effectiveStartTime=Math.max(activeTimer.startTime,startOfDay);const durationToday=Date.now()-effectiveStartTime;let pausedToday=0;if(activeTimer.isPaused){const pauseDuration=Date.now()-activeTimer.pauseStartTime;if(activeTimer.pauseStartTime>startOfDay){pausedToday+=pauseDuration;}}
            totalMs+=elapsed>0?elapsed:0;}
            return totalMs;
        };
        const downloadFile=(data,name,type)=>{const b=new Blob([data],{type});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);};

        let db;const DB_VERSION=26;
        const openDB=()=>new Promise(r=>{const req=indexedDB.open('timeTrackerDB',DB_VERSION);req.onupgradeneeded=e=>{db=e.target.result;if(!db.objectStoreNames.contains('projects'))db.createObjectStore('projects',{keyPath:'id'});if(!db.objectStoreNames.contains('tasks'))db.createObjectStore('tasks',{keyPath:'id',autoIncrement:true}).createIndex('projectId','projectId');if(!db.objectStoreNames.contains('accomplishments'))db.createObjectStore('accomplishments',{keyPath:'id',autoIncrement:true}).createIndex('date','date');if(db.objectStoreNames.contains('dailyTasks'))db.deleteObjectStore('dailyTasks');if(!db.objectStoreNames.contains('predefinedTasks'))db.createObjectStore('predefinedTasks',{keyPath:'id',autoIncrement:true});};req.onsuccess=e=>{db=e.target.result;r(db)};});
        const addData=(s,d)=>new Promise((rs,rj)=>{const r=db.transaction(s,'readwrite').objectStore(s).add(d);r.onsuccess=e=>rs(e.target.result);r.onerror=e=>rj(e.target.error);});
        const updateData=(s,d)=>new Promise((rs,rj)=>{const r=db.transaction(s,'readwrite').objectStore(s).put(d);r.onsuccess=()=>rs();r.onerror=e=>rj(e.target.error);});
        const deleteData=(s,i)=>new Promise(r=>db.transaction(s,'readwrite').objectStore(s).delete(i).onsuccess=()=>r());
        const getAllData=(s)=>new Promise(r=>db.transaction(s,'readonly').objectStore(s).getAll().onsuccess=e=>r(e.target.result));
        const clearData=(s)=>new Promise(r=>db.transaction(s,'readwrite').objectStore(s).clear().onsuccess=()=>r());

        const loadData=async()=>{await openDB();[projects,tasks,accomplishments,predefinedTasks]=await Promise.all([getAllData('projects'),getAllData('tasks'),getAllData('accomplishments'),getAllData('predefinedTasks')]);renderDashboardProjects();updateDashboardTotalTime();};
        const checkPersistentTimer=()=>{const s=localStorage.getItem('activeTimerState');if(s){activeTimer=JSON.parse(s);startTimerInterval();}};

        const applyTheme=(t)=>{if(t==='dark'){document.documentElement.classList.add('dark');if(dom.darkModeToggle)dom.darkModeToggle.checked=true;}else{document.documentElement.classList.remove('dark');if(dom.darkModeToggle)dom.darkModeToggle.checked=false;}};
        const toggleTheme=()=>{const n=(localStorage.getItem('theme')||'light')==='dark'?'light':'dark';localStorage.setItem('theme',n);applyTheme(n);};

        const exportDataAsJSON=async(isAuto=false)=>{const all={projects:await getAllData('projects'),tasks:await getAllData('tasks'),accomplishments:await getAllData('accomplishments'), predefinedTasks:await getAllData('predefinedTasks')};const d=new Date().toISOString().split('T')[0];const f=isAuto?`work_app_auto_backup_${d}.json`:'work_app_manual_backup.json';downloadFile(JSON.stringify(all,null,2),f,'application/json');if(isAuto)localStorage.setItem('lastAutoBackup',new Date().toISOString());};
        const importDataFromJSON=(e)=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=async(ev)=>{try{const d=JSON.parse(ev.target.result);if(!d.projects||!d.tasks)throw new Error("Invalid format.");if(confirm("This will overwrite all current data. Are you sure?")){await Promise.all([clearData('projects'),clearData('tasks'),clearData('accomplishments'),clearData('predefinedTasks')]);const importedProjects=d.projects.map(p=>({id:p.id,name:p.name,color:p.color,status:p.isComplete?'completed':'open',description:p.description||'',estimate:p.estimate||0}));const importedTasks=d.tasks.map(t=>{if(t.duration&&t.timestamp&&!t.startTime){return{projectId:t.projectId,description:t.description,startTime:t.timestamp-t.duration,endTime:t.timestamp,notes:t.notes||'',tags:t.tags||[]};}
                        return t;});await Promise.all(importedProjects.map(p=>addData('projects',p)));await Promise.all(importedTasks.map(t=>addData('tasks',t)));if(d.accomplishments)await Promise.all(d.accomplishments.map(a=>addData('accomplishments',a)));if(d.predefinedTasks)await Promise.all(d.predefinedTasks.map(t=>addData('predefinedTasks',t)));alert("Imported!");await loadData();navigateTo('page-tracker');}}catch(err){alert("Failed: "+err.message);}finally{if(dom.importFileInput)dom.importFileInput.value=null;}};r.readAsText(f);};
        const exportTasksAsCSV=()=>{const s=dom.csvDateStart.value,e=dom.csvDateEnd.value;if(!s||!e)return alert("Please select dates.");const sMs=new Date(s).getTime(),eMs=new Date(e).setHours(23,59,59,999);const fTs=tasks.filter(t=>t.startTime>=sMs&&t.startTime<=eMs);if(fTs.length===0)return alert("No tasks in date range.");const pM=new Map(projects.map(p=>[p.id,p]));let c='Project,Description,Notes,Tags,Date,Start,End,Duration\n';fTs.forEach(t=>{const p=pM.get(t.projectId)||{};const dMs=t.endTime-t.startTime;const sT=new Date(t.startTime),eT=new Date(t.endTime);const r=[`"${p.name||''}"`,`"${(t.description||'').replace(/"/g,'""')}"`,`"${(t.notes||'').replace(/"/g,'""')}"`,`"${(t.tags||[]).join(', ')}"`,sT.toLocaleDateString(),sT.toLocaleTimeString(),eT.toLocaleTimeString(),formatTime(dMs)];c+=r.join(',')+'\n';});downloadFile(c,`work_app_export_${s}_to_${e}.csv`,'text/csv;charset=utf-8;');};
        const scheduleAutomaticBackup=()=>{if(localStorage.getItem('autoBackupEnabled')!=='true')return;const lB=localStorage.getItem('lastAutoBackup');const n=new Date();if(lB){const lBD=new Date(lB);if(lBD.toDateString()===n.toDateString())return;}if(n.getHours()>=12){exportDataAsJSON(true).then(updateLastBackupInfo);}};
        const updateLastBackupInfo=()=>{const lB=localStorage.getItem('lastAutoBackup');if(lB){if(dom.lastBackupInfo)dom.lastBackupInfo.textContent=`Last backup: ${new Date(lB).toLocaleDateString()}`;}else{if(dom.lastBackupInfo)dom.lastBackupInfo.textContent='Backs up at 12:00 PM daily.';}};

        const openModal=(el)=>{document.getElementById('modal-backdrop').classList.remove('hidden');el.classList.remove('hidden');};
        const closeModal=(el)=>{document.getElementById('modal-backdrop').classList.add('hidden');el.classList.add('hidden');};
        
        const updatePageHeader=(pageId)=>{const now=new Date();const dateString=now.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'});const timeString=now.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});if(pageId==='page-tracker'){const el=document.getElementById('tracker-date-display');if(el)el.textContent=dateString;}
            if(pageId==='page-accomplishments'){const el=document.getElementById('accomplishments-date-display');if(el)el.textContent=dateString;}
            if(pageId==='page-reports'){const el=document.getElementById('reports-date-display');if(el)el.textContent=`${dateString}`;}};

        const navigateTo=(pageId)=>{document.querySelectorAll('.page').forEach(p=>p.classList.toggle('active',p.id===pageId));document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active',b.dataset.page===pageId));if(pageId==='page-reports')renderReportsPage();if(pageId==='page-accomplishments')renderAccomplishmentsPage();if(pageId==='page-settings')renderSettingsPage();if(pageId==='page-tasks')renderTasksPage();if(pageId==='page-completed-projects')renderCompletedProjectsPage();updatePageHeader(pageId);};

        const startTimerInterval=()=>{if(timerInterval)clearInterval(timerInterval);timerInterval=setInterval(()=>{if(activeTimer&&!activeTimer.isPaused){const elapsed=Date.now()-activeTimer.startTime-activeTimer.totalPausedTime;const el=document.querySelector(`.project-card.is-running .live-timer-display`);if(el)el.textContent=formatTime(elapsed>0?elapsed:0);updateDashboardTotalTime();}},1000);};
        const stopTimerInterval=()=>{clearInterval(timerInterval);timerInterval=null;};
        
        const focusOnCard = (card) => {
            if (!card || isAnimating) return;
            isAnimating = true;
            document.body.classList.add('focus-mode-active');

            const list = document.getElementById('dashboard-projects-list');
            const rect = card.getBoundingClientRect();

            const placeholder = document.createElement('div');
            placeholder.className = 'project-card-placeholder';
            placeholder.style.width = `${rect.width}px`;
            placeholder.style.height = `${rect.height}px`;
            
            if(card.parentElement === list) {
                list.insertBefore(placeholder, card);
            }

            focusedCardState = { card, placeholder };

            Object.assign(card.style, {
                position: 'fixed',
                left: `${rect.left}px`,
                top: `${rect.top}px`,
                width: `${rect.width}px`,
                height: `${rect.height}px`,
                zIndex: '50',
                transition: 'all 0.5s cubic-bezier(0.645, 0.045, 0.355, 1)'
            });
            
            card.classList.add('is-focused');
            if (list) list.classList.add('card-focused-mode');

            requestAnimationFrame(() => {
                const vw = window.innerWidth;
                const vh = window.innerHeight;
                
                let targetWidth = Math.min(600, vw * 0.9);
                let targetHeight = Math.min(500, vh * 0.8);

                Object.assign(card.style, {
                    left: `${(vw - targetWidth) / 2}px`,
                    top: `${(vh - targetHeight) / 2}px`,
                    width: `${targetWidth}px`,
                    height: `${targetHeight}px`
                });
                setTimeout(() => { isAnimating = false; }, 500);
            });
        };

        const unfocusCard = () => {
            return new Promise(resolve => {
                if (!focusedCardState || isAnimating) {
                    resolve();
                    return;
                }
                isAnimating = true;
                document.body.classList.remove('focus-mode-active');
                const { card, placeholder } = focusedCardState;
                const list = document.getElementById('dashboard-projects-list');

                const rect = placeholder.getBoundingClientRect();
                
                Object.assign(card.style, {
                    left: `${rect.left}px`,
                    top: `${rect.top}px`,
                    width: `${rect.width}px`,
                    height: `${rect.height}px`
                });
                
                if (list) list.classList.remove('card-focused-mode');

                const onEnd = (event) => {
                    if (event && event.target !== card) return;
                    card.removeEventListener('transitionend', onEnd);
                    Object.assign(card.style, {
                        position: '', left: '', top: '', width: '', height: '', zIndex: '', transition: ''
                    });
                    card.classList.remove('is-focused');
                    if (placeholder) placeholder.remove();
                    focusedCardState = null;
                    isAnimating = false;
                    resolve();
                };
                card.addEventListener('transitionend', onEnd);
                setTimeout(() => { // Fallback in case transitionend does not fire
                    onEnd(null);
                }, 550);
            });
        };

        const updateRunningCard = () => {
            if (!activeTimer) return;
            const card = document.querySelector(`.project-card.is-running`);
            if (!card) return;

            const timerDisplay = card.querySelector('.timer-display');
            const timerControlsContainer = card.querySelector('.flex.justify-end.h-10');

            if (timerDisplay) {
                timerDisplay.classList.toggle('text-yellow-500', activeTimer.isPaused);
                timerDisplay.classList.toggle('text-green-500', !activeTimer.isPaused);
            }
            
            if (timerControlsContainer) {
                 const newControls = activeTimer.isPaused
                    ? `<div class="flex items-center space-x-2">
                        <button class="timer-control-btn resume-timer-btn bg-green-500 text-white w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-play text-xl"></i></button>
                        <button class="timer-control-btn stop-timer-btn bg-red-500 text-white w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-stop text-xl"></i></button>
                       </div>`
                    : `<div class="flex items-center space-x-2">
                        <button class="timer-control-btn pause-timer-btn bg-yellow-500 text-white w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-pause text-xl"></i></button>
                        <button class="timer-control-btn stop-timer-btn bg-red-500 text-white w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-stop text-xl"></i></button>
                       </div>`;
                timerControlsContainer.innerHTML = newControls;
            }
        };

        const startTimer = async (id) => {
            if (isAnimating) return;
            if (activeTimer) await stopTimer();
        
            const now = Date.now();
            activeTimer = { projectId: id, description: '', notes: '', tags: [], startTime: now, totalPausedTime: 0, isPaused: false, pauseStartTime: null };
            localStorage.setItem('activeTimerState', JSON.stringify(activeTimer));
            startTimerInterval();
            renderDashboardProjects();
        
            setTimeout(() => {
                const card = document.querySelector(`.project-card[data-project-id="${id}"]`);
                if (card) {
                    focusOnCard(card);
                }
            }, 50); 
        };

        const pauseTimer=()=>{
            if (!activeTimer || activeTimer.isPaused) return;
            activeTimer.isPaused=true;
            activeTimer.pauseStartTime=Date.now();
            localStorage.setItem('activeTimerState', JSON.stringify(activeTimer));
            stopTimerInterval();
            updateRunningCard();
        };
        const resumeTimer=()=>{
            if (!activeTimer || !activeTimer.isPaused) return;
            activeTimer.totalPausedTime += Date.now() - activeTimer.pauseStartTime;
            activeTimer.isPaused = false;
            activeTimer.pauseStartTime = null;
            localStorage.setItem('activeTimerState', JSON.stringify(activeTimer));
            startTimerInterval();
            updateRunningCard();
        };

        const stopTimer = async () => {
            if (!activeTimer || isAnimating) return;
            
            const cardDataSource = focusedCardState?.card || document.querySelector(`.project-card[data-project-id="${activeTimer.projectId}"]`);
            if (cardDataSource) {
                activeTimer.description = cardDataSource.querySelector('.task-description-input')?.value || '';
                activeTimer.notes = cardDataSource.querySelector('.task-notes-input')?.value || '';
                const tagsInput = cardDataSource.querySelector('.task-tags-input')?.value.trim();
                activeTimer.tags = tagsInput ? tagsInput.split(/[\s,]+/).map(t => t.startsWith('#') ? t : t) : [];
            }

            const endTime = activeTimer.isPaused ? activeTimer.pauseStartTime : Date.now();
            const duration = (endTime - activeTimer.startTime) - activeTimer.totalPausedTime;
            const t = { projectId: activeTimer.projectId, description: activeTimer.description || 'Untitled Task', notes: activeTimer.notes, tags: activeTimer.tags, startTime: activeTimer.startTime, endTime: activeTimer.startTime + duration };
            
            const newId = await addData('tasks', t);
            t.id = newId;
            tasks.push(t);

            localStorage.removeItem('activeTimerState');
            activeTimer = null;
            stopTimerInterval();
            
            await unfocusCard();
            
            renderDashboardProjects();
            updateDashboardTotalTime();
        };
        
        const saveNewProject=async(e)=>{e.preventDefault();const modal=document.getElementById('add-project-modal');const name=modal.querySelector('#new-project-name').value.trim();const color=modal.querySelector('#new-project-color').value;const description=modal.querySelector('#new-project-description').value.trim();if(!name||!color){alert("Project name and color are required.");return;}const p={id:Date.now(),name,description,color:color,estimate:parseFloat(modal.querySelector('#new-project-estimate').value)||0,status:'open'};await addData('projects',p);projects.push(p);renderDashboardProjects();closeModal(modal);modal.querySelector('form').reset();};
        const updateProject=async(id,data)=>{const p=projects.find(proj=>proj.id===id);if(p){Object.assign(p,data);await updateData('projects',p);openProjectDetailView(id);renderDashboardProjects();}};

        const updateDashboardTotalTime=()=>{const el=document.getElementById('dashboard-total-time');if(!el)return;const sD=new Date().setHours(0,0,0,0);let t=tasks.filter(t=>t.endTime>=sD).reduce((s,t)=>s+(t.endTime-t.startTime),0);if(activeTimer){let elapsed;if(activeTimer.isPaused){elapsed=activeTimer.pauseStartTime-activeTimer.startTime-activeTimer.totalPausedTime;}else{elapsed=Date.now()-activeTimer.startTime-activeTimer.totalPausedTime;}
            t+=elapsed>0?elapsed:0;}
            el.textContent=formatDuration(t);};
        
        const renderDashboardProjects=()=>{
            const openProjects=projects.filter(p=>p.status!=='completed');
            let sP=[...openProjects];
            if(currentSort==='name'){sP.sort((a,b)=>a.name.localeCompare(b.name));}
            else if(currentSort.startsWith('time')){const direction=currentSort==='time_desc'?-1:1;sP.sort((a,b)=>(getTodaysTimeForProjectMs(b.id)-getTodaysTimeForProjectMs(a.id))*direction);}
            else{const l={};tasks.forEach(t=>{if(!l[t.projectId]||t.endTime>l[t.projectId])l[t.projectId]=t.endTime;});sP.sort((a,b)=>(l[b.id]||0)-(l[a.id]||0));}
            
            document.getElementById('dashboard-projects-list').innerHTML=sP.map(p=>{
                const isR=activeTimer?.projectId===p.id;
                const totalTimeOverallMs=getTotalTimeForProject(p.id);
                const timeTodayMs=getTodaysTimeForProjectMs(p.id);
                const pgr=p.estimate>0?(totalTimeOverallMs/(p.estimate*3600000))*100:0;
                
                const expC=`<div class="expanded-content">
                    <div class="h-full">
                        <div class="pt-4 flex flex-col h-full relative">
                            <div class="relative mb-3 flex-shrink-0">
                                <input type="text" placeholder="What are you working on?" class="task-description-input w-full p-2 rounded-md border border-[var(--input-border)] bg-[var(--input-bg)]" value="${isR ? activeTimer.description : ''}">
                                <div class="custom-task-dropdown hidden"></div>
                            </div>
                            <textarea placeholder="Notes..." class="task-notes-input w-full p-2 rounded-md border bg-[var(--input-bg)] flex-grow resize-none">${isR ? activeTimer.notes : ''}</textarea>
                            <input type="text" placeholder="Add tags... (#meeting)" class="task-tags-input w-full p-2 mt-3 rounded-md border bg-[var(--input-bg)] flex-shrink-0" value="${isR ? (activeTimer.tags || []).join(' ') : ''}">
                        </div>
                    </div>
                </div>`;
                
                let liveDisplayTime="00:00:00";
                if(isR){
                    let elapsed;
                    if(activeTimer.isPaused){elapsed=activeTimer.pauseStartTime-activeTimer.startTime-activeTimer.totalPausedTime;}
                    else{elapsed=Date.now()-activeTimer.startTime-activeTimer.totalPausedTime;}
                    liveDisplayTime=formatTime(elapsed>0?elapsed:0);
                }
                
                const timerControls = isR
                    ? `<div class="flex items-center space-x-2">
                        <button class="timer-control-btn ${activeTimer.isPaused ? 'resume-timer-btn bg-green-500' : 'pause-timer-btn bg-yellow-500'} text-white w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"><i class="fa-solid ${activeTimer.isPaused ? 'fa-play' : 'fa-pause'} text-xl"></i></button>
                        <button class="timer-control-btn stop-timer-btn bg-red-500 text-white w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-stop text-xl"></i></button>
                       </div>`
                    : `<div class="flex items-center">
                        <button class="timer-control-btn start-timer-btn w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-play text-2xl"></i></button>
                       </div>`;

                const todaysLoggedTasks = tasks.filter(t => t.projectId === p.id && new Date(t.startTime).toDateString() === new Date().toDateString());
                const projectPredefinedTasks = predefinedTasks.filter(t => t.projectId === p.id);
                const hasTasks = todaysLoggedTasks.length > 0 || projectPredefinedTasks.length > 0;

                let tasksTodayHTML = `<div class="mt-4 border-t border-[var(--border)] text-sm hidden lg:block ${hasTasks ? 'overflow-y-auto pt-2' : ''}" style="max-height: 6rem;">`;
                if (hasTasks) {
                    tasksTodayHTML += '<h3 class="font-semibold text-xs text-[var(--muted-foreground)] mb-1 sticky top-0 bg-[var(--card)]/80 backdrop-blur-sm z-[1]">Today\'s Activity</h3>';
                    tasksTodayHTML += '<ul class="space-y-1">';
                    todaysLoggedTasks.forEach(t => {
                        tasksTodayHTML += `<li class="flex items-center gap-2 text-xs truncate" title="${t.description}"><i class="fa-solid fa-check text-green-500 w-4 text-center"></i><span class="flex-grow truncate">${t.description}</span><span class="font-mono text-[var(--muted-foreground)] flex-shrink-0">${formatDuration(t.endTime - t.startTime)}</span></li>`;
                    });
                    const loggedDescriptions = todaysLoggedTasks.map(t => t.description.trim().toLowerCase());
                    projectPredefinedTasks.forEach(t => {
                        if (!loggedDescriptions.includes(t.description.trim().toLowerCase())) {
                            tasksTodayHTML += `<li class="flex items-center gap-2 text-xs truncate text-[var(--muted-foreground)]" title="${t.description}"><i class="fa-regular fa-circle text-xs w-4 text-center"></i><span class="flex-grow truncate">${t.description}</span></li>`;
                        }
                    });
                    tasksTodayHTML += '</ul>';
                } else {
                    tasksTodayHTML += '<div class="flex items-center justify-center h-full"><p class="text-xs text-[var(--muted-foreground)]">No tasks for this project.</p></div>';
                }
                tasksTodayHTML += '</div>';

                const progressBarHTML = p.estimate > 0 ? `<div class="progress-bar-bg mt-auto"><div class="progress-bar-fg" style="width:${Math.min(100,pgr)}%;background-color:${p.color};"></div></div>` : '';

                return`<div class="project-card bg-[var(--card)] rounded-xl shadow-sm border border-[var(--border)] p-4 transition-all duration-300 relative flex flex-col justify-between ${isR?'is-running':''}" style="--project-color:${p.color};--project-color-glow:${p.color}40;" data-project-id="${p.id}">
                    <div>
                        <div class="flex justify-between items-start gap-2">
                            <div class="flex items-start space-x-4 min-w-0">
                                <span class="w-4 h-4 rounded-full flex-shrink-0 mt-1.5" style="background-color:${p.color};"></span>
                                <div class="min-w-0 flex-grow">
                                    <button class="font-semibold project-name-link truncate text-left hover:underline text-lg w-full" data-project-id="${p.id}">${p.name}</button>
                                    <div class="text-sm font-medium text-gray-500 h-5">
                                        ${isR ? `Total: ${formatDuration(totalTimeOverallMs)}` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 lg:flex-col lg:items-end lg:space-x-0 flex-shrink-0">
                                <div class="text-2xl font-bold lg:mb-2 ${isR && !activeTimer.isPaused ? 'text-green-500 live-timer-display' : (isR && activeTimer.isPaused ? 'text-yellow-500' : 'text-gray-400')} timer-display">${isR ? liveDisplayTime : formatDuration(timeTodayMs)}</div>
                                <div class="flex justify-end h-10">${timerControls}</div>
                            </div>
                        </div>
                        ${expC}
                    </div>
                    <div class="flex-grow flex flex-col justify-end mt-2">
                        ${tasksTodayHTML}
                        ${progressBarHTML}
                    </div>
                </div>`;
            }).join('');
        };
        
        const renderReportsPage=()=>{
            const content=document.getElementById('reports-page-template').content.cloneNode(true);
            document.getElementById('reports-content').innerHTML='';
            document.getElementById('reports-content').appendChild(content);

            const dayPicker = document.getElementById('reports-day-picker');
            dayPicker.value = new Date().toISOString().split('T')[0];
            dayPicker.addEventListener('change', () => renderReportData('day'));

            renderReportData('week');
        };

        const renderReportData=(filter,range={})=>{
            const exportBtn = document.getElementById('export-day-notes-btn');
            const dayPickerContainer = document.getElementById('reports-day-picker-container');
            if(exportBtn) exportBtn.classList.toggle('hidden', filter !== 'day');
            if(dayPickerContainer) dayPickerContainer.classList.toggle('hidden', filter !== 'day');
            
            let sD,eD;const n=new Date();
            if(filter==='day'){
                const picker = document.getElementById('reports-day-picker');
                const reportDate = picker ? new Date(picker.value + 'T00:00:00') : n;
                sD=new Date(reportDate).setHours(0,0,0,0);
                eD=new Date(reportDate).setHours(23,59,59,999);
            }else if(filter==='week'){const d=n.getDay()===0?6:n.getDay()-1,f=n.getDate()-d;sD=new Date(new Date(n).setDate(f)).setHours(0,0,0,0);eD=new Date(new Date(n).setDate(f+6)).setHours(23,59,59,999);}else if(filter==='month'){sD=new Date(n.getFullYear(),n.getMonth(),1);eD=new Date(n.getFullYear(),n.getMonth()+1,0).setHours(23,59,59,999);}
            else if(filter==='custom'&&range.start&&range.end){
                sD=new Date(range.start + 'T00:00:00').getTime();
                eD=new Date(range.end + 'T00:00:00').setHours(23,59,59,999);
            }
            const fTs=tasks.filter(t=>t.startTime>=sD&&t.startTime<=eD);

            const totalTimeMs = fTs.reduce((sum, task) => sum + (task.endTime - task.startTime), 0);
            const totalTimeEl = document.getElementById('reports-total-time');
            if (totalTimeEl) {
                totalTimeEl.textContent = formatDuration(totalTimeMs);
            }

            const groupedByProject=fTs.reduce((acc,task)=>{(acc[task.projectId]=acc[task.projectId]||[]).push(task);return acc;},{});
            const summaryEl=document.getElementById('reports-summary');if(!summaryEl)return;summaryEl.innerHTML=projects.filter(p=>groupedByProject[p.id]).map(p=>{const projectTasks=groupedByProject[p.id];const totalTime=projectTasks.reduce((sum,t)=>sum+(t.endTime-t.startTime),0);return`<details class="bg-[var(--card)] p-3 rounded-lg border"><summary class="font-semibold flex justify-between items-center cursor-pointer"><span>${p.name}</span><span style="color:${p.color};">${formatDuration(totalTime)}</span></summary><div class="mt-3 pt-3 border-t space-y-2">${projectTasks.sort((a,b)=>b.startTime-a.startTime).map(t=>`<div class="text-sm flex justify-between"><span>${t.description}</span><span class="text-[var(--muted-foreground)]">${formatDuration(t.endTime-t.startTime)}</span></div>`).join('')}</div></details>`;}).join('')||'<p class="text-center text-[var(--muted-foreground)] py-8 col-span-full">No time tracked in this period.</p>';
        };
        
        const exportDayNotesAsMarkdown = () => {
            const dayPicker = document.getElementById('reports-day-picker');
            if (!dayPicker || !dayPicker.value) {
                alert("Please select a day to export.");
                return;
            }
            
            const reportDate = new Date(dayPicker.value + 'T00:00:00');
            reportDate.setHours(0,0,0,0);
            const startOfDay = reportDate.getTime();
            const endOfDay = startOfDay + (24 * 60 * 60 * 1000 - 1);

            const dayTasks = tasks.filter(t => t.startTime >= startOfDay && t.startTime <= endOfDay && t.notes);

            if (dayTasks.length === 0) {
                alert("No notes found for " + reportDate.toLocaleDateString());
                return;
            }

            const tasksByProject = dayTasks.reduce((acc, task) => {
                const p = projects.find(proj => proj.id === task.projectId);
                const projectName = p ? p.name : 'Uncategorized';
                if (!acc[projectName]) {
                    acc[projectName] = [];
                }
                acc[projectName].push(task);
                return acc;
            }, {});

            let markdown = `Daily Notes: ${reportDate.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n\n`;

            for (const projectName in tasksByProject) {
                markdown += `# ${projectName}\n\n`;
                tasksByProject[projectName]
                    .sort((a, b) => a.startTime - b.startTime)
                    .forEach(task => {
                        if (task.description) {
                            markdown += `## ${task.description}\n`;
                        }
                        if (task.notes) {
                            markdown += `${task.notes}\n\n`;
                        }
                    });
            }

            const filename = `work_app_notes_${reportDate.toISOString().split('T')[0]}.md`;
            downloadFile(markdown, filename, 'text/markdown;charset=utf-8;');
        };

        const renderSettingsPage=()=>{const content=document.getElementById('settings-template').content.cloneNode(true);document.getElementById('settings-content').innerHTML='';document.getElementById('settings-content').appendChild(content);dom.darkModeToggle=document.getElementById('dark-mode-toggle');dom.autoBackupToggle=document.getElementById('auto-backup-toggle');dom.lastBackupInfo=document.getElementById('last-backup-info');dom.importFileInput=document.getElementById('import-file-input');dom.csvDateStart=document.getElementById('csv-date-start');dom.csvDateEnd=document.getElementById('csv-date-end');applyTheme(localStorage.getItem('theme')||'light');dom.autoBackupToggle.checked=localStorage.getItem('autoBackupEnabled')==='true';updateLastBackupInfo();document.getElementById('detected-time-zone').textContent=Intl.DateTimeFormat().resolvedOptions().timeZone;};
        const renderAccomplishmentsPage=()=>{const content=document.getElementById('accomplishments-page-template').content.cloneNode(true);const ac=document.getElementById('accomplishments-content');ac.innerHTML='';ac.appendChild(content);const listEl=document.getElementById('accomplishments-list');listEl.innerHTML=accomplishments.sort((a,b)=>b.date-a.date).map(acc=>{const p=projects.find(j=>j.id===acc.projectId);return`<div class="bg-[var(--card)] p-3 rounded-lg border"><p>${acc.text}</p><div class="flex flex-wrap gap-1 mt-2">${(acc.tags||[]).map(g=>`<span class="tag">${g}</span>`).join('')}</div><div class="flex justify-between items-center mt-2"><p class="text-xs text-[var(--muted-foreground)] font-semibold" style="color:${p?.color||'gray'}">${p?.name||'No Project'}&bull;${new Date(acc.date).toLocaleDateString()}</p><button class="edit-accomplishment-btn p-2" data-accomplishment-id="${acc.id}"><i class="fa-solid fa-pencil text-sm"></i></button></div></div>`;}).join('')||'<p class="text-center text-[var(--muted-foreground)] py-8 col-span-full">No accomplishments yet.</p>';};
        const saveAccomplishment=async e=>{e.preventDefault();const modal=document.getElementById('add-accomplishment-modal');const id=modal.querySelector('#accomplishment-id').value;const pId=parseInt(modal.querySelector('#accomplishment-project-select').value);const t=modal.querySelector('#accomplishment-text').value.trim();if(!t)return;const tagsInput=modal.querySelector('#accomplishment-tags').value.trim();const tags=tagsInput?tagsInput.split(/[\s,]+/).map(tag=>tag.startsWith('#')?tag:tag):[];const date=new Date(modal.querySelector('#accomplishment-date').value+'T00:00:00').getTime();const accData={projectId:pId||null,text:t,tags,date};if(id){const accomplishment=accomplishments.find(a=>a.id===parseInt(id));Object.assign(accomplishment,accData);await updateData('accomplishments',accomplishment);}else{const newId=await addData('accomplishments',accData);accData.id=newId;accomplishments.push(accData);}closeModal(modal);renderAccomplishmentsPage();};
        
        const renderTasksPage=()=>{const content=document.getElementById('tasks-page-template').content.cloneNode(true);const tc=document.getElementById('tasks-content');tc.innerHTML='';tc.appendChild(content);const listEl=document.getElementById('predefined-tasks-list');
            const groupedByProject=predefinedTasks.reduce((acc,task)=>{(acc[task.projectId||'none']=acc[task.projectId||'none']||[]).push(task);return acc;},{});
            listEl.innerHTML=projects.concat({id:'none',name:'General Tasks'}).filter(p=>groupedByProject[p.id]).map(p=>{return`<div><h2 class="font-bold text-lg mt-4 mb-2" style="color:${p.color||'inherit'}">${p.name}</h2><div class="space-y-2">${groupedByProject[p.id].map(task=>{const isDoneToday=task.isCompleted&&new Date(task.completedDate).toDateString()===new Date().toDateString();return`<div class="flex items-center bg-[var(--card)] p-3 rounded-lg border" data-task-id="${task.id}"><input type="checkbox" class="predefined-task-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-4 flex-shrink-0" ${isDoneToday?'checked':''}> <div class="flex-grow min-w-0"><p class="font-medium ${isDoneToday?'line-through text-gray-500':''}">${task.description}</p>${task.dueDate?`<p class="text-sm text-[var(--muted-foreground)]">Due: ${new Date(task.dueDate+'T00:00:00').toLocaleDateString()}</p>`:''}${task.notes?`<p class="text-sm text-[var(--muted-foreground)]">${task.notes}</p>`:''}<div class="flex flex-wrap gap-1 mt-1">${(task.tags||[]).map(g=>`<span class="tag">${g}</span>`).join('')}</div></div><div class="flex items-center"><button class="edit-predefined-task-btn p-2 rounded-md hover:bg-[var(--muted)]"><i class="fa-solid fa-pencil"></i></button><button class="delete-predefined-task-btn p-2 rounded-md hover:bg-[var(--muted)]"><i class="fa-solid fa-trash-can"></i></button></div></div>`}).join('')}</div></div>`}).join('')||'<p class="text-center text-[var(--muted-foreground)] py-8">No tasks yet. Add one!</p>';};
        const savePredefinedTask=async e=>{e.preventDefault();const modal=document.getElementById('add-predefined-task-modal');const id=modal.querySelector('#predefined-task-id').value;const description=modal.querySelector('#predefined-task-desc').value.trim();if(!description)return;const projectId=parseInt(modal.querySelector('#predefined-task-project').value)||null;const notes=modal.querySelector('#predefined-task-notes').value.trim();const tags=modal.querySelector('#predefined-task-tags').value.split(',').map(t=>t.trim()).filter(Boolean);const dueDate=modal.querySelector('#predefined-task-due-date').value;const taskData={description,projectId,notes,tags,dueDate:dueDate||null};if(id){const task=predefinedTasks.find(t=>t.id===parseInt(id));Object.assign(task,taskData);await updateData('predefinedTasks',task);}else{const newId=await addData('predefinedTasks',{...taskData,isCompleted:false,completedDate:null});taskData.id=newId;predefinedTasks.push(taskData);}closeModal(modal);renderTasksPage();};
        
        const renderCompletedProjectsPage=()=>{const completedProjects=projects.filter(p=>p.status==='completed');const contentEl=document.getElementById('completed-projects-content');contentEl.innerHTML=`<div class="flex items-center justify-between mb-6"><h1 class="text-2xl font-bold">Completed Projects</h1><button class="back-to-dashboard-btn font-semibold text-blue-600 hover:underline">Back to Dashboard</button></div><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">${completedProjects.length>0?completedProjects.map(p=>`<div class="bg-[var(--card)] p-3 rounded-lg border flex items-center justify-between"><div class="flex items-center space-x-3"><span class="w-3 h-3 rounded-full" style="background-color:${p.color};"></span><button class="font-semibold completed-project-link hover:underline" data-project-id="${p.id}">${p.name}</button></div></div>`).join(''):'<p class="text-center text-[var(--muted-foreground)] py-8 col-span-full">No completed projects.</p>'}</div>`;};
        const openProjectDetailView=(id)=>{navigateTo('page-detail');currentDetailProjectId=id;const p=projects.find(p=>p.id===id);if(!p)return;const projectTasks=predefinedTasks.filter(t=>t.projectId===id);const tasksHTML=`<div class="mt-6"><h2 class="font-semibold mb-2">Task List</h2><div class="space-y-2">${projectTasks.length>0?projectTasks.map(t=>`<div class="bg-[var(--card)] p-2 rounded-lg border text-sm">${t.description}</div>`).join(''):'<p class="text-sm text-[var(--muted-foreground)]">No tasks defined for this project yet.</p>'}</div></div>`;const statusRadios=`<div class="flex items-center gap-6 mt-4"><p class="text-sm font-medium text-[var(--muted-foreground)]">Project Status:</p><div class="flex items-center gap-4"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="project-status" value="open" class="project-status-radio" ${p.status!=='completed'?'checked':''}> Open</label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="project-status" value="completed" class="project-status-radio" ${p.status==='completed'?'checked':''}> Completed</label></div></div>`;document.getElementById('detail-view-content').innerHTML=`<div id="project-detail-view-mode"><header class="flex items-start justify-between mb-2"><div><h1 class="text-2xl font-bold" style="color:${p.color};">${p.name}</h1></div><div class="flex items-center gap-2"><button id="edit-project-btn" class="p-2 rounded-md hover:bg-[var(--muted)]"><i class="fa-solid fa-pencil text-xl"></i></button></div></header><p class="text-sm text-[var(--muted-foreground)] mb-4">${p.description||'No description.'}</p><button id="add-manual-entry-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold border border-[var(--input-border)] hover:bg-[var(--muted)]">Add Time</button>${statusRadios}</div><div id="project-detail-edit-mode" class="hidden mt-6 mb-6 space-y-3 p-4 bg-[var(--muted)] rounded-lg"><div class="flex gap-4"><input type="text" id="edit-project-name" class="w-full p-2 text-xl font-bold border rounded-md bg-[var(--input-bg)]" value="${p.name}"><div id="edit-color-palette" class="flex flex-wrap gap-2"></div><input type="hidden" id="edit-project-color" value="${p.color}"></div><textarea id="edit-project-description" rows="2" class="w-full p-2 text-sm border rounded-md bg-[var(--input-bg)]">${p.description||''}</textarea><div class="grid grid-cols-2 gap-4"><input type="number" id="edit-project-estimate" placeholder="Estimate (hrs)" value="${p.estimate||''}" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]"></div><div class="flex justify-end gap-2"><button id="cancel-edit-project-btn" class="font-semibold px-5 py-2 text-base rounded-lg hover:bg-gray-300">Cancel</button><button id="save-updated-project-btn" class="font-semibold px-5 py-2 text-base rounded-lg bg-[var(--primary)] text-[var(--primary-foreground)]">Save</button></div></div><div class="mb-6 p-4 bg-[var(--card)] rounded-xl border mt-6"><p class="text-sm text-[var(--muted-foreground)]">Total Time for Period</p><p id="detail-total-time" class="text-3xl font-bold">0h 0m</p></div><div id="detail-date-filters" class="p-2 bg-[var(--muted)] rounded-xl flex text-center text-sm font-semibold my-4"><button data-filter="today" class="detail-filter-btn flex-1 py-2 rounded-lg bg-[var(--card)] shadow">Today</button><button data-filter="week" class="detail-filter-btn flex-1 py-2 rounded-lg">Week</button><button data-filter="month" class="detail-filter-btn flex-1 py-2 rounded-lg">Month</button><button data-filter="custom" class="detail-filter-btn flex-1 py-2 rounded-lg">Custom</button></div><div id="detail-custom-range" class="hidden flex items-center gap-2 text-sm mb-4"><input type="date" id="detail-date-start" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]"><span class="text-[var(--muted-foreground)]">to</span><input type="date" id="detail-date-end" class="w-full p-2 border rounded-md text-sm bg-[var(--input-bg)]"></div><div id="detail-entries-list" class="space-y-3"></div>${tasksHTML}`;renderProjectEntries(id,'today');};
        const renderProjectEntries=(id,filter,range={})=>{let sD,eD;const n=new Date();if(filter==='today'){sD=new Date().setHours(0,0,0,0);eD=new Date().setHours(23,59,59,999);}else if(filter==='week'){const d=n.getDay()===0?6:n.getDay()-1,f=n.getDate()-d;sD=new Date(new Date(n).setDate(f)).setHours(0,0,0,0);eD=new Date(new Date(n).setDate(f+6)).setHours(23,59,59,999);}else if(filter==='month'){sD=new Date(n.getFullYear(),n.getMonth(),1);eD=new Date(n.getFullYear(),n.getMonth()+1,0).setHours(23,59,59,999);}else if(filter==='range'&&range.start&&range.end){sD=new Date(range.start).getTime();eD=new Date(range.end).setHours(23,59,59,999);}const fTs=tasks.filter(t=>t.projectId===id&&t.startTime>=sD&&t.startTime<=eD).sort((a,b)=>b.startTime-a.startTime);const tMs=fTs.reduce((s,t)=>s+(t.endTime-t.startTime),0);const tEl=document.getElementById('detail-total-time');if(tEl)tEl.textContent=formatDuration(tMs);const lEl=document.getElementById('detail-entries-list');if(lEl)lEl.innerHTML=fTs.length>0?fTs.map(t=>createTaskEntryHTML(t,projects.find(p=>p.id===t.projectId))).join(''):`<p class="text-center p-4">No entries.</p>`;};
        const createTaskEntryHTML=(t,p)=>{const sT=new Date(t.startTime),eT=new Date(t.endTime);const dur=formatDuration(t.endTime-t.startTime);const dStr=sT.toLocaleDateString([],{month:'short',day:'numeric',year:'numeric'});const tStr=`${sT.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} - ${eT.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`;return`<div class="task-entry bg-[var(--card)] p-3 rounded-lg border" data-task-id="${t.id}"><div class="view-mode"><div class="flex justify-between items-start"><div class="flex-grow"><p class="font-semibold">${t.description}</p><p class="text-sm text-[var(--muted-foreground)] whitespace-pre-wrap">${t.notes||'No notes'}</p><div class="text-sm text-[var(--muted-foreground)] mt-2">${dStr} &bull; ${tStr}</div></div><div class="flex items-center gap-1 ml-2 flex-shrink-0"><span class="font-semibold text-base mr-2">${dur}</span><button class="edit-task-btn p-2 rounded-md hover:bg-[var(--muted)]"><i class="fa-solid fa-pencil"></i></button><button class="delete-task-btn p-2 rounded-md hover:bg-[var(--muted)]"><i class="fa-solid fa-trash-can"></i></button></div></div></div><div class="edit-mode hidden space-y-2 mt-2"><input class="w-full p-2 text-sm border rounded-md bg-[var(--input-bg)] edit-task-description" value="${t.description}"><textarea class="w-full p-2 text-sm border rounded-md h-20 bg-[var(--input-bg)] edit-task-notes">${t.notes||''}</textarea><input type="text" placeholder="Add tags..." class="w-full p-2 text-sm border rounded-md bg-[var(--input-bg)]" value="${(t.tags||[]).join(' ')}"><div class="flex items-center gap-2"><input type="date" class="w-full p-1 text-xs border rounded-md bg-[var(--input-bg)]" value="${sT.toISOString().split('T')[0]}"><input type="time" class="w-full p-1 text-xs border" value="${sT.toTimeString().slice(0,5)}"><input type="time" class="w-full p-1 text-xs border" value="${eT.toTimeString().slice(0,5)}"></div><div class="flex justify-end gap-2"><button class="cancel-edit-btn px-4 py-2 text-sm rounded-md">Cancel</button><button class="save-task-btn px-4 py-2 text-sm text-white bg-blue-600 rounded-md">Save</button></div></div></div>`;};
        const saveManualEntry=async e=>{e.preventDefault();const desc=document.getElementById('manual-entry-desc').value,date=document.getElementById('manual-entry-date').value,start=document.getElementById('manual-entry-start').value,end=document.getElementById('manual-entry-end').value,notes=document.getElementById('manual-entry-notes').value;if(!desc||!date||!start||!end)return;const startTime=new Date(`${date}T${start}`).getTime(),endTime=new Date(`${date}T${end}`).getTime();if(startTime>=endTime)return;const newTask={projectId:currentDetailProjectId,description:desc,notes,startTime,endTime,tags:[]};const newId=await addData('tasks',newTask);newTask.id=newId;tasks.push(newTask);closeModal(document.getElementById('manual-entry-modal'));const cF=document.querySelector('#detail-date-filters .detail-filter-btn.active').dataset.filter;renderProjectEntries(currentDetailProjectId,cF);updateDashboardTotalTime();renderDashboardProjects();};
        const showUserGuide=()=>{document.getElementById('guide-content').innerHTML=`<h2 class="text-2xl font-bold mb-4">Welcome to the work app!</h2><div class="prose dark:prose-invert max-w-none space-y-4 text-[var(--foreground)]"><p>This guide explains the features to help you track time effectively.</p><h3 class="font-semibold">1. Creating a Project</h3><p>Use the '+' button on the main screen to create a new project. You can add a name, description, color, and an optional time estimate.</p><h3 class="font-semibold">2. Tasks</h3><p>Go to the Tasks page (clipboard icon) to create reusable tasks for your projects. This saves you from typing the same task name repeatedly.</p><h3 class="font-semibold">3. Tracking Time</h3><ul><li>Click the play button on a project card to start the timer.</li><li>You can select a task or type a new one.</li><li>Use the pause button to take a break without creating a new time entry.</li><li>Click the stop button to end and save the time entry.</li></ul><h3 class="font-semibold">4. PWA & Automatic Backups</h3><ul><li><strong>Installable App (PWA):</strong> Your browser may show an option to "Install" or "Add to Home Screen" to use this app like a native app.</li><li><strong>Automatic Backups:</strong> In <strong>Settings</strong>, enable "Automatic Daily Backups" to save a JSON backup to your downloads folder every day after 12:00 PM.</li></ul></div>`;openModal(document.getElementById('guide-modal'));};
        
        document.body.addEventListener('click',async e=>{
            const navBtn = e.target.closest('.nav-btn');
            if (navBtn) return navigateTo(navBtn.dataset.page);

            if(e.target.closest('#add-project-btn-dashboard')){const palette=document.getElementById('color-palette');palette.innerHTML=PALETTE.map(c=>`<div class="color-swatch" style="background-color: ${c}" data-color="${c}"></div>`).join('');document.getElementById('new-project-color').value='';openModal(document.getElementById('add-project-modal'));}
            if(e.target.closest('.color-swatch')){document.querySelectorAll('.color-swatch').forEach(el=>el.classList.remove('selected'));e.target.classList.add('selected');document.getElementById('new-project-color').value=e.target.dataset.color;}
            if(e.target.closest('#cancel-add-project-btn'))return closeModal(document.getElementById('add-project-modal'));if(e.target.closest('.sort-btn')){const sortBtn=e.target.closest('.sort-btn');document.querySelectorAll('.sort-btn').forEach(b=>{b.classList.remove('active');});sortBtn.classList.add('active');const sortType=sortBtn.dataset.sort;if(sortType==='time'){const arrow=sortBtn.querySelector('.sort-arrow');arrow.style.display='inline';const currentDir=sortBtn.dataset.dir;const newDir=currentDir==='desc'?'asc':'desc';sortBtn.dataset.dir=newDir;arrow.textContent=newDir==='desc'?'▼':'▲';currentSort=`time_${newDir}`;}else{currentSort=sortType;}renderDashboardProjects();return;}
            if(e.target.closest('.reports-filter-btn')){const btn=e.target.closest('.reports-filter-btn');document.querySelectorAll('.reports-filter-btn').forEach(b=>b.classList.remove('bg-[var(--card)]','shadow'));btn.classList.add('bg-[var(--card)]','shadow');document.getElementById('reports-custom-range').classList.toggle('hidden',btn.dataset.filter!=='custom');renderReportData(btn.dataset.filter);}
            if(e.target.closest('#add-accomplishment-btn')){const modal=document.getElementById('add-accomplishment-modal');modal.querySelector('form').reset();modal.querySelector('#accomplishment-modal-title').textContent="Log an Accomplishment";const select=modal.querySelector('#accomplishment-project-select');select.innerHTML=`<option value="">No Project</option>`+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');modal.querySelector('#accomplishment-date').value=new Date().toISOString().slice(0,10);openModal(modal);}
            if(e.target.closest('.edit-accomplishment-btn')){const id=parseInt(e.target.closest('.edit-accomplishment-btn').dataset.accomplishmentId);const acc=accomplishments.find(a=>a.id===id);if(acc){const modal=document.getElementById('add-accomplishment-modal');modal.querySelector('form').reset();modal.querySelector('#accomplishment-modal-title').textContent="Edit Accomplishment";const select=modal.querySelector('#accomplishment-project-select');select.innerHTML=`<option value="">No Project</option>`+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');modal.querySelector('#accomplishment-id').value=acc.id;modal.querySelector('#accomplishment-project-select').value=acc.projectId||'';modal.querySelector('#accomplishment-text').value=acc.text;modal.querySelector('#accomplishment-tags').value=(acc.tags||[]).join(', ');modal.querySelector('#accomplishment-date').value=new Date(acc.date).toISOString().slice(0,10);openModal(modal);}}
            if(e.target.closest('#cancel-add-accomplishment-btn'))return closeModal(document.getElementById('add-accomplishment-modal'));if(e.target.closest('#import-json-btn'))dom.importFileInput.click();if(e.target.closest('#export-json-btn'))exportDataAsJSON(false);if(e.target.closest('#export-csv-btn'))exportTasksAsCSV();if(e.target.closest('#export-day-notes-btn')){exportDayNotesAsMarkdown();}if(e.target.closest('#show-guide-btn'))showUserGuide();if(e.target.closest('#close-guide-btn'))closeModal(document.getElementById('guide-modal'));if(e.target.closest('#add-predefined-task-btn')){const modal=document.getElementById('add-predefined-task-modal');modal.querySelector('form').reset();modal.querySelector('#predefined-task-modal-title').textContent="New Task";const select=modal.querySelector('#predefined-task-project');select.innerHTML=`<option value="">General Task</option>`+projects.filter(p=>p.status!=='completed').map(p=>`<option value="${p.id}">${p.name}</option>`).join('');openModal(modal);}
            if(e.target.closest('#cancel-add-predefined-task-btn'))return closeModal(document.getElementById('add-predefined-task-modal'));
            if(e.target.closest('.delete-predefined-task-btn')){const taskEl=e.target.closest('[data-task-id]');if(taskEl){const taskId=parseInt(taskEl.dataset.taskId);if(confirm('Delete this pre-defined task?')){await deleteData('predefinedTasks',taskId);predefinedTasks=predefinedTasks.filter(t=>t.id!==taskId);renderTasksPage();}}}
            if(e.target.closest('.edit-predefined-task-btn')){const taskEl=e.target.closest('[data-task-id]');if(taskEl){const taskId=parseInt(taskEl.dataset.taskId);const task=predefinedTasks.find(t=>t.id===taskId);if(task){const modal=document.getElementById('add-predefined-task-modal');modal.querySelector('form').reset();modal.querySelector('#predefined-task-modal-title').textContent="Edit Task";const select=modal.querySelector('#predefined-task-project');select.innerHTML=`<option value="">General Task</option>`+projects.filter(p=>p.status!=='completed').map(p=>`<option value="${p.id}">${p.name}</option>`).join('');modal.querySelector('#predefined-task-id').value=task.id;modal.querySelector('#predefined-task-desc').value=task.description;modal.querySelector('#predefined-task-project').value=task.projectId||'';modal.querySelector('#predefined-task-due-date').value=task.dueDate||'';modal.querySelector('#predefined-task-notes').value=task.notes||'';modal.querySelector('#predefined-task-tags').value=(task.tags||[]).join(', ');openModal(modal);}}}
            if(e.target.closest('#view-completed-projects-btn'))navigateTo('page-completed-projects');
            const card=e.target.closest('.project-card');if(card && !isAnimating){const pId=parseInt(card.dataset.projectId);if(e.target.closest('.start-timer-btn'))startTimer(pId);if(e.target.closest('.stop-timer-btn'))stopTimer();if(e.target.closest('.pause-timer-btn'))pauseTimer();if(e.target.closest('.resume-timer-btn'))resumeTimer();if(e.target.closest('.project-name-link'))openProjectDetailView(pId);}
            const detailView=e.target.closest('#detail-view-content');if(detailView){if(e.target.closest('#add-manual-entry-btn')){const modal=document.getElementById('manual-entry-modal');modal.querySelector('form').reset();openModal(modal);}
            if(e.target.closest('#cancel-manual-entry-btn'))closeModal(document.getElementById('manual-entry-modal'));if(e.target.closest('#edit-project-btn')){detailView.querySelector('#project-detail-view-mode').classList.add('hidden');detailView.querySelector('#project-detail-edit-mode').classList.remove('hidden');const p=projects.find(proj=>proj.id===currentDetailProjectId);const palette=detailView.querySelector('#edit-color-palette');palette.innerHTML=PALETTE.map(c=>`<div class="color-swatch ${p.color===c?'selected':''}" style="background-color: ${c}" data-color="${c}"></div>`).join('');}
            if(e.target.closest('#edit-color-palette .color-swatch')){detailView.querySelectorAll('#edit-color-palette .color-swatch').forEach(el=>el.classList.remove('selected'));e.target.classList.add('selected');detailView.querySelector('#edit-project-color').value=e.target.dataset.color;}
            if(e.target.closest('#cancel-edit-project-btn')){detailView.querySelector('#project-detail-view-mode').classList.remove('hidden');detailView.querySelector('#project-detail-edit-mode').classList.add('hidden');}
            if(e.target.closest('#save-updated-project-btn')){const data={name:detailView.querySelector('#edit-project-name').value,description:detailView.querySelector('#edit-project-description').value,color:detailView.querySelector('#edit-project-color').value,estimate:parseFloat(detailView.querySelector('#edit-project-estimate').value)||0,};await updateProject(currentDetailProjectId,data);detailView.querySelector('#project-detail-view-mode').classList.remove('hidden');detailView.querySelector('#project-detail-edit-mode').classList.add('hidden');}
            if(e.target.closest('#detail-date-filters .detail-filter-btn')){const btn=e.target.closest('.detail-filter-btn');detailView.querySelectorAll('#detail-date-filters .detail-filter-btn').forEach(b=>b.classList.remove('bg-[var(--card)]','shadow'));btn.classList.add('bg-[var(--card)]','shadow');detailView.querySelector('#detail-custom-range').classList.toggle('hidden',btn.dataset.filter!=='custom');renderProjectEntries(currentDetailProjectId,btn.dataset.filter);}
            const entryEl=e.target.closest('.task-entry');if(entryEl){const tId=parseInt(entryEl.dataset.taskId);if(e.target.closest('.delete-task-btn')){if(confirm('Delete entry?')){await deleteData('tasks',tId);tasks=tasks.filter(t=>t.id!==tId);renderProjectEntries(currentDetailProjectId,document.querySelector('#detail-date-filters .detail-filter-btn.active').dataset.filter);updateDashboardTotalTime();renderDashboardProjects();}}
            else if(e.target.closest('.edit-task-btn')){entryEl.querySelector('.view-mode').classList.add('hidden');entryEl.querySelector('.edit-mode').classList.remove('hidden');const notesInput=entryEl.querySelector('.edit-task-notes');if(notesInput){notesInput.dispatchEvent(new Event('input',{bubbles:true}));}}
            else if(e.target.closest('.cancel-edit-btn')){entryEl.querySelector('.view-mode').classList.remove('hidden');entryEl.querySelector('.edit-mode').classList.add('hidden');}
            else if(e.target.closest('.save-task-btn')){const t=tasks.find(t=>t.id===tId);if(!t)return;const i=entryEl.querySelectorAll('.edit-mode input, .edit-mode textarea');t.description=i[0].value;t.notes=i[1].value;t.tags=i[2].value.trim().split(/[\s,]+/).filter(Boolean);const nD=i[3].value;t.startTime=new Date(`${nD}T${i[4].value}`).getTime();t.endTime=new Date(`${nD}T${i[5].value}`).getTime();await updateData('tasks',t);renderProjectEntries(currentDetailProjectId,document.querySelector('#detail-date-filters .detail-filter-btn.active').dataset.filter);updateDashboardTotalTime();renderDashboardProjects();}}}
            const completedProjectsView=e.target.closest('#page-completed-projects');if(completedProjectsView){if(e.target.closest('.back-to-dashboard-btn'))navigateTo('page-tracker');if(e.target.closest('.completed-project-link')){const pId=parseInt(e.target.closest('.completed-project-link').dataset.projectId);openProjectDetailView(pId);}}});
        
        document.getElementById('add-project-form').addEventListener('submit',saveNewProject);
        document.getElementById('manual-entry-form').addEventListener('submit',saveManualEntry);
        document.getElementById('add-predefined-task-form').addEventListener('submit',savePredefinedTask);
        document.getElementById('add-accomplishment-form').addEventListener('submit',saveAccomplishment);
        document.getElementById('modal-backdrop').addEventListener('click',()=>{closeModal(document.getElementById('add-project-modal'));closeModal(document.getElementById('guide-modal'));closeModal(document.getElementById('manual-entry-modal'));closeModal(document.getElementById('add-predefined-task-modal'));closeModal(document.getElementById('add-accomplishment-modal'));});
        
        document.body.addEventListener('change',async e=>{
            if(e.target.closest('#dark-mode-toggle'))toggleTheme();
            if(e.target.closest('#auto-backup-toggle'))localStorage.setItem('autoBackupEnabled',e.target.checked);
            if(e.target.matches('#import-file-input'))importDataFromJSON(e);
            if(e.target.matches('#reports-date-start')||e.target.matches('#reports-date-end')){const sE=document.getElementById('reports-date-start'),eE=document.getElementById('reports-date-end');if(sE&&eE&&sE.value&&eE.value)renderReportData('custom',{start:sE.value,end:eE.value});}
            if(e.target.matches('.predefined-task-checkbox')){const taskEl=e.target.closest('[data-task-id]');const taskId=parseInt(taskEl.dataset.taskId);const task=predefinedTasks.find(t=>t.id===taskId);if(task){task.isCompleted=e.target.checked;task.completedDate=e.target.checked?Date.now():null;await updateData('predefinedTasks',task);renderTasksPage();}}
            const detailView=e.target.closest('#detail-view-content');if(detailView){if(e.target.matches('.project-status-radio')){const newStatus=e.target.value;const p=projects.find(proj=>proj.id===currentDetailProjectId);if(p&&p.status!==newStatus){const oldStatus=p.status;p.status=newStatus;await updateData('projects',p);renderDashboardProjects();if(oldStatus==='open'&&newStatus==='completed'){navigateTo('page-completed-projects');}else if(oldStatus==='completed'&&newStatus==='open'){navigateTo('page-tracker');}}}
            const sE=detailView.querySelector('#detail-date-start'),eE=detailView.querySelector('#detail-date-end');if(sE&&eE&&sE.value&&eE.value){detailView.querySelectorAll('#detail-date-filters .detail-filter-btn').forEach(b=>b.classList.remove('bg-[var(--card)]','shadow'));renderProjectEntries(currentDetailProjectId,'range',{start:sE.value,end:eE.value});}}});
        
        document.getElementById('dashboard-projects-list').addEventListener('input',e=>{const input=e.target;if(input.matches('.task-description-input')){const card=input.closest('.project-card');const pId=parseInt(card.dataset.projectId);const dropdown=card.querySelector('.custom-task-dropdown');const projectTasks=predefinedTasks.filter(t=>t.projectId===pId || !t.projectId);const filter=input.value.toLowerCase();const filteredTasks=projectTasks.filter(t=>t.description.toLowerCase().includes(filter));dropdown.innerHTML=filteredTasks.map(t=>`<div class="p-2 hover:bg-[var(--muted)] cursor-pointer">${t.description}</div>`).join('');dropdown.classList.toggle('hidden',!filteredTasks.length);if(activeTimer)activeTimer.description=input.value;localStorage.setItem('activeTimerState',JSON.stringify(activeTimer));}
        else if(e.target.matches('.task-notes-input')||e.target.matches('.task-tags-input')){if(!activeTimer)return;if(e.target.matches('.task-notes-input'))activeTimer.notes=e.target.value;else if(e.target.matches('.task-tags-input'))activeTimer.tags=e.target.value.trim().split(/[\s,]+/).filter(Boolean);localStorage.setItem('activeTimerState',JSON.stringify(activeTimer));}});
        document.getElementById('dashboard-projects-list').addEventListener('focusin', e => { if (e.target.matches('.task-description-input')) { const card = e.target.closest('.project-card'); const dropdown = card.querySelector('.custom-task-dropdown'); dropdown.classList.remove('hidden'); e.target.dispatchEvent(new Event('input', { bubbles: true })); }});
        document.getElementById('dashboard-projects-list').addEventListener('focusout', e => { if (e.target.matches('.task-description-input')) { setTimeout(() => { const card = e.target.closest('.project-card'); const dropdown = card.querySelector('.custom-task-dropdown'); if (dropdown) dropdown.classList.add('hidden'); }, 150); }});
        document.getElementById('dashboard-projects-list').addEventListener('mousedown', e => { if (e.target.closest('.custom-task-dropdown > div')) { const card = e.target.closest('.project-card'); const input = card.querySelector('.task-description-input'); input.value = e.target.textContent; card.querySelector('.custom-task-dropdown').classList.add('hidden'); if(activeTimer) { activeTimer.description = input.value; localStorage.setItem('activeTimerState', JSON.stringify(activeTimer)); } e.preventDefault(); }});
        
        const initializeApp=()=>{loadData();checkPersistentTimer();navigateTo('page-tracker');};
        initializeApp();
    });

    /*
    ==================================================================
    PWA Instructions
    ==================================================================
    To make this app fully "installable" on a phone or desktop,
    you need to create these two files in the same folder as your HTML file.

    1. Create a file named: manifest.json
    --------------------------------------
    {
      "name": "the work app", "short_name": "WorkApp", "description": "A client-side time tracking application.",
      "start_url": "./[YOUR_HTML_FILE_NAME].html", "display": "standalone", "background_color": "#ffffff", "theme_color": "#030213",
      "icons": [ { "src": "icon-192.png", "sizes": "192x192", "type": "image/png" }, { "src": "icon-512.png", "sizes": "512x512", "type": "image/png" } ]
    }
    NOTE: You will need to create icon-192.png and icon-512.png image files.

    2. Create a file named: sw.js
    -------------------------------
    const CACHE_NAME = 'work-app-cache-v1';
    const urlsToCache = [ './[YOUR_HTML_FILE_NAME].html' ];
    self.addEventListener('install', e => { e.waitUntil( caches.open(CACHE_NAME).then(c => c.addAll(urlsToCache)) ); });
    self.addEventListener('fetch', e => { e.respondWith( caches.match(e.request).then(r => r || fetch(e.request)) ); });
    ==================================================================
    */
    </script>
</body>
</html>
